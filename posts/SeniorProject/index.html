<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Copeland Carter">
<meta name="dcterms.date" content="2024-04-30">

<title>smartycope - Senior Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="smartycope - Senior Project">
<meta property="og:description" content="Test description">
<meta property="og:image" content="https://smartycope.org/posts/SeniorProject/index.png">
<meta property="og:site_name" content="smartycope">
<meta property="og:image:height" content="558">
<meta property="og:image:width" content="430">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">smartycope</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://avatars.githubusercontent.com/u/60020173?v=4"> <i class="bi bi-smartycope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Senior Project</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/smartycope/SquarePacking/blob/master/Attempt4.ipynb">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">projects</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">ML</div>
                <div class="quarto-category">highlighted</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Copeland Carter </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 30, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#dependant-code" id="toc-dependant-code" class="nav-link" data-scroll-target="#dependant-code">Dependant Code</a></li>
  <li><a href="#the-script" id="toc-the-script" class="nav-link" data-scroll-target="#the-script">The Script</a>
  <ul class="collapse">
  <li><a href="#dependancies" id="toc-dependancies" class="nav-link" data-scroll-target="#dependancies">Dependancies</a></li>
  <li><a href="#configuration-enviorment" id="toc-configuration-enviorment" class="nav-link" data-scroll-target="#configuration-enviorment">Configuration &amp; Enviorment</a></li>
  <li><a href="#ddpg-buffer" id="toc-ddpg-buffer" class="nav-link" data-scroll-target="#ddpg-buffer">DDPG Buffer</a></li>
  <li><a href="#define-actor-critic-models" id="toc-define-actor-critic-models" class="nav-link" data-scroll-target="#define-actor-critic-models">Define Actor &amp; Critic Models</a></li>
  <li><a href="#hyperparameters" id="toc-hyperparameters" class="nav-link" data-scroll-target="#hyperparameters">Hyperparameters</a></li>
  <li><a href="#main-loop" id="toc-main-loop" class="nav-link" data-scroll-target="#main-loop">Main Loop</a></li>
  <li><a href="#example-log" id="toc-example-log" class="nav-link" data-scroll-target="#example-log">Example Log</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
  <li><a href="#my-guesses-as-to-what-is-wrong" id="toc-my-guesses-as-to-what-is-wrong" class="nav-link" data-scroll-target="#my-guesses-as-to-what-is-wrong">My Guesses as to What is Wrong</a></li>
  <li><a href="#a-different-kind-of-hueristic-algorithm" id="toc-a-different-kind-of-hueristic-algorithm" class="nav-link" data-scroll-target="#a-different-kind-of-hueristic-algorithm">A Different Kind of Hueristic Algorithm</a></li>
  </ul></li>
  <li><a href="#summary-part-2" id="toc-summary-part-2" class="nav-link" data-scroll-target="#summary-part-2">Summary Part 2</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="emailto:smartycope@gmail.com" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://github.com/smartycope"><i class="bi bi-github"></i>GitHub Profile</a></li><li><a href="https://www.linkedin.com/in/smartycope/"><i class="bi bi-linkedin"></i>LinkedIn Profile</a></li><li><a href="../../Resumé v6.1.2.ds.pdf"><i class="bi bi-file-earmark-person"></i>My Resumé</a></li><li><a href="/"><i class="bi bi-wifi"></i>Live Projects</a></li><li><a href="https://ezregex.org/"><i class="bi bi-dash"></i>EZRegex</a></li><li><a href="https://smartycope.org/geodoodle/"><i class="bi bi-dash"></i>GeoDoodle</a></li><li><a href="https://github.com/smartycope"><i class="bi bi-github"></i>Signature GitHub Repos</a></li><li><a href="https://github.com/smartycope/ezregex"><i class="bi bi-dash"></i>EZRegex Repo</a></li><li><a href="https://github.com/smartycope/geodoodle"><i class="bi bi-dash"></i>GeoDoodle Repo</a></li><li><a href="https://pypi.org/project/ezregex/"><i class="bi bi-box"></i>Published Packages</a></li><li><a href="https://pypi.org/project/ezregex/"><i class="bi bi-dash"></i>EZRegex Package</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>My senior project was attempting to use a reinforcement learning algorithm based on a <a href="https://spinningup.openai.com/en/latest/algorithms/ddpg.html">Deep Deterministic Policy Gradient</a> model for use with a continuous observation <em>and</em> action space, in order to solve the <a href="https://en.wikipedia.org/wiki/Square_packing">Square Packing in a Square</a> problem for N=11 squares.</p>
<p>You can read the initial proposal <a href="https://smartycope.org/posts/SquarePacking/">here</a></p>
<p>This file/post is intended to be entirely self-contained. You should be able to run/copy it directly and have it all work.</p>
<div id="cell-3" class="cell">
<details class="code-fold">
<summary>Spoiler Alert</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I did not succeed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I created a custom RL enviorment, built off the <a href="https://gymnasium.farama.org/">Gymnasium</a> library, specifically my own personal SimpleGym class, published my own <a href="https://pypi.org/project/Cope/">Cope</a> package.</p>
<p>Both the action and observation spaces have the shape <code>(3*N, )</code> (N is the number of squares, so 11) where each square has an x, y and rotation values. The actor’s actions simply get added to the current square positions and rotations (since the actor actions can be negative), so the actor can make small adjustments to squeze the squares closer to each other.</p>
<p>I went though several different versions of the reward function. Here’s my final version, with explanations of what each part is doing:</p>
<div id="cell-5" class="cell" data-execution_count="19">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Reward Function</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_reward(<span class="va">self</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The score starts off as positive, because we generally prefer longer episodes</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> <span class="dv">100</span> <span class="co"># Linear</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are all customizable coefficients</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    small_side_len <span class="op">=</span> <span class="fl">5.5</span> <span class="co"># Scalar</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    longevity_importance <span class="op">=</span> <span class="fl">.5</span> <span class="co"># Multiplied</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    side_importance <span class="op">=</span> <span class="dv">100</span> <span class="co"># Multiplied</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    centered_importance <span class="op">=</span> <span class="dv">0</span> <span class="co"># Exponential</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    boundary_badness <span class="op">=</span> <span class="dv">0</span> <span class="co"># Linear</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.boundary:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        boundary_badness <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We like longer episodes</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    score <span class="op">+=</span> <span class="va">self</span>.steps <span class="op">*</span> longevity_importance</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is the "main" value we want to optimize: the side length</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># All the other stuff is to help it optimize this quicker</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It's set so "small" side lengths set a positive reward,</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and "large" side lengths set a negative reward</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    score <span class="op">-=</span> (<span class="va">self</span>.side_len <span class="op">-</span> small_side_len) <span class="op">*</span> side_importance</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I tried making it exponential for a time (it didn't seem to help)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># score -= math.e**(self.side_len * side_importance)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We like it if they're in a small area</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.side_len <span class="op">&lt;</span> small_side_len <span class="kw">and</span> <span class="va">self</span>.start_config <span class="op">!=</span> <span class="st">'array'</span>:</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> <span class="dv">200</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We want to incentivize not touching, instead of disincentivizing touching,</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># because this way it doesn't also disincentivize longer runs</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (if the reward is positive by default (not touching), then a longer run is okay)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We don't like it when they overlap at all</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This isn't relevant when we don't allow overlap in the first place</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.overlap_area <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        score <span class="op">-=</span> <span class="dv">100_000</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We really don't like it when they overlap -- the configuration is invalid if they do</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        score <span class="op">-=</span> math.e<span class="op">**</span>(<span class="va">self</span>.overlap_area)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I don't want them to just push up against the edges</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This creates a "boundary" on the sides which, when squares are in it, the reward goes down</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> boundary_badness <span class="kw">or</span> centered_importance:</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x, y, _rot <span class="kw">in</span> <span class="va">self</span>.squares:</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Left</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> x <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> boundary_badness</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Top</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> y <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> boundary_badness</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Right</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(x <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> boundary_badness</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Bottom</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(y <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> boundary_badness</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We want the squares to be close to the center</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This is in the same loop out for the sake of efficiency</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> centered_importance:</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> (math.e <span class="op">**</span> dist([x, y], [<span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>, <span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>]) <span class="op">*</span> centered_importance) <span class="op">/</span> <span class="va">self</span>.N</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="dependant-code" class="level2">
<h2 class="anchored" data-anchor-id="dependant-code">Dependant Code</h2>
<p>For reproducibility’s sake, here is the rest of the relevant custom code I used in this project (because although my Cope package is published, it’s <em>not</em> stable):</p>
<div id="cell-8" class="cell" data-execution_count="2">
<div class="code-with-filename">
<details class="code-fold">
<summary>RedirectStd</summary>
<div class="code-with-filename-file">
<pre><strong>misc.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io, sys</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> randint</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedirectStd:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, stdout<span class="op">=</span><span class="va">None</span>, stderr<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(stdout, io.TextIOBase):</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._stdout <span class="op">=</span> stdout</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._stdout <span class="op">=</span> <span class="bu">open</span>(stdout <span class="kw">or</span> os.devnull, <span class="st">'w'</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(stderr, io.TextIOBase):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._stderr <span class="op">=</span> stderr</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._stderr <span class="op">=</span> <span class="bu">open</span>(stderr <span class="kw">or</span> os.devnull, <span class="st">'w'</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__enter__</span>(<span class="va">self</span>):</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.old_stdout, <span class="va">self</span>.old_stderr <span class="op">=</span> sys.stdout, sys.stderr</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.old_stdout.flush()<span class="op">;</span> <span class="va">self</span>.old_stderr.flush()</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        sys.stdout, sys.stderr <span class="op">=</span> <span class="va">self</span>._stdout, <span class="va">self</span>._stderr</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__exit__</span>(<span class="va">self</span>, exc_type, exc_value, traceback):</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._stdout.flush()<span class="op">;</span> <span class="va">self</span>._stderr.flush()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._stdout.close()<span class="op">;</span> <span class="va">self</span>._stderr.close()</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        sys.stdout <span class="op">=</span> <span class="va">self</span>.old_stdout</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        sys.stderr <span class="op">=</span> <span class="va">self</span>.old_stderr</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> interpret_percentage(percentage:<span class="bu">int</span> <span class="op">|</span> <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(percentage, <span class="bu">bool</span>):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(percentage)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> percentage <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> percentage <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> percentage</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> percent(percentage:<span class="bu">int</span> <span class="op">|</span> <span class="bu">float</span>):</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Usage:</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">        if (percent(50)):</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;code that has a 50% chance of running&gt;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="al">NOTE</span><span class="co">: .5 works as well as 50</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> randint(<span class="dv">1</span>, <span class="dv">100</span>) <span class="op">&lt;</span> interpret_percentage(percentage)<span class="op">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="code-with-filename">
<details class="code-fold">
<summary>SimpleGym</summary>
<div class="code-with-filename-file">
<pre><strong>SimpleGym.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sys <span class="im">import</span> exit</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABC</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep, time <span class="im">as</span> now</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gymnasium <span class="im">as</span> gym</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygame</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpleGym(gym.Env, ABC):</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" A simplified Gymnasium enviorment that uses pygame and handles some stuff for you, like rendering</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">        keeping track of steps, returning the right things from the right functions, event handling,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">        including some default keyboard shortcuts, and some debugging features. Includes easy ways</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">        to print to the screen.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        **Rendering**</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">            By default, it's set to render the enviorment according to the function render_pygame, which</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">            should render everything to self.surf. If you would like to specify other rendering methods,</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">            define them as `render_{method_name}`, and render() will handle it for you. There's no need</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">            to manually overwrite the render() method.</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">        **Printing**</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">            There are 3 ways to print to the screen:</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">                `show_vars`: accessable either via the constructor or as a member</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">                    This is a dictionary of {name: member} of members you want to have printed</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">                    on the screen. The keys can be any string, and the values must be valid members</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">                    of this class. The screen is updated as the member changes.</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">                `show_strings`: accessable either via the constructor, as a member, or the show() function</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">                    This is a list of strings that are printed to the screen. They won't change.</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">                    Useful for showing config options and the like. They are always printed first.</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">                `print`: a dictionary member. The keys are arbitrary and not printed. The values</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">                    are printed to the screen. The reason it's a dictionary and not a list is simply</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">                    for easy indexing: you can change this in the middle of the running loop, and</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">                    it will get added to the screen. Just make sure to reuse the keys.</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">                    Attempting to set an item on an instance will also set it to print</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">                    (i.e. `env['a'] = 'string'` is the same as `env.print['a'] = 'string'`)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Default key handling:</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">            q closes the window</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">            space toggles pause</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">            i increments a single frame</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">            u runs the debug_button()</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">            r runs reset() immediately</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">            f toggles whether we're limiting ourselves to FPS or not</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">            h shows a help menu on screen</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">            &gt;/&lt; increase and decrease the FPS</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co">        In order to use this effectively, you need to overload:</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co">            __init__(), if you want to add any members</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">            _get_obs()</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">            _get_reward()</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co">            _step(action), don't overload step(), step() calls _step</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co">            _reset(seed=None, options=None), if you need any custom reset code (don't overload reset())</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co">            render_pygame(), render to self.surf</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co">        and optionally:</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co">            _get_terminated(), if you want to use custom terminated criteria other than just max_steps</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co">                You *don't* need to call super()._get_terminated()</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">            _get_info(), if you want to include info</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">            handle_event(event), for handling events</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co">            debug_button(), for debugging when you press the u key</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co">            _get_truncated(), if you want to include truncated</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co">        Helpful members provided:</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="co">            `width`, `height`: the dimentions of the screen</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co">            `size`: set to self.width, for compatibility's sake</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co">            `just_reset`: is set to True by reset() and False by step()</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co">            `steps`: the number of steps in the current episode</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co">            `total_steps`: the total number of steps taken</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="co">            `reset_count`: a count of the number of times reset() has been called</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="co">            `surf`: the surface to draw to in render_pygame()</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co">            `paused`: True if paused</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="co">            `increment`: set to True internally to denote a single step while paused. step() sets</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="co">                to False</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    FPS_STEP <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    SHOW_HELP_FADE_TIME <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    FONT_SIZE <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    HELP_TEXT <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="st">        q: close window</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="st">        space: toggle pause</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="st">        i: increment a single frame</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="st">        u: run debug_button()</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="st">        r: reset</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="st">        f: toggle limit FPS</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;/&gt;: change FPS</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="st">        d: toggle displaying</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="st">        h: show/hide this menu</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        max_steps<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        screen_size<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        fps<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">'SimpleGym Enviorment'</span>,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        show_vars<span class="op">=</span>{},</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        show_strings<span class="op">=</span>[],</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        start_paused<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        render_mode<span class="op">=</span><span class="st">'pygame'</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        displaying<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span><span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        assert_valid_action<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        background_color<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">20</span>),</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        print_color<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">0</span>),</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        show_events<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" This should be called first, if you  want to use the members like self.size</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a><span class="co">            Parameters:</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="co">                `max_steps`: if positive, sets the maximum number of steps before the env resets</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="co">                    itself. If None or negative, no limit</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a><span class="co">                `screen_size`: the size of the pygame window. Can be a 2 item tuple of (width, height)</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a><span class="co">                    or a single int if the window is to be square</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a><span class="co">                `fps`: controls how fast the simulation runs. Set to negative or None to have no limit</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="co">                `name`: the name of the enviorment shown on the window title</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="co">                `show_vars`: a dictionary of {name: member} of members you want to have printed</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a><span class="co">                    on the screen. The keys can be any string, and the values must be valid members</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="co">                    of this class</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="co">                `show_strings`: a list of strings you want to have printed on the screen</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="co">                `start_paused`: self-explanitory</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a><span class="co">                `show_events`: prints events, other than mouse movements, for debugging purpouses</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="co">                `render_mode`: part of the gymnasium specification. Must be either None or 'pygame',</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a><span class="co">                    unless you manually override the render() method</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a><span class="co">                `displaying`: turn off to not render, to go faster</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a><span class="co">                `print`: whether we automatically render self.print to the screen. You can use self.display() to</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a><span class="co">                    display to a Jupyter Notebook instead. It still renders show_strings.</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="co">                `assert_valid_action`: ensures that actions given to step() are within the action_space</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a><span class="co">                `background_color`: a 3 item tuple specifying the background color</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a><span class="co">                `print_color`: a 4 item tuple (the 4th index being alpha) specifying the color of</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="co">                    the extra data printed to the screen</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a><span class="co">                `verbose`: when set to True, it simply adds `fps`, `reset_count`, `steps`, `total_steps`</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a><span class="co">                    to `show_vars`. Also shows the help menu for the first few seconds</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metadata <span class="op">=</span> {<span class="st">"render_modes"</span>: <span class="bu">list</span>({<span class="st">'pygame'</span>, render_mode}), <span class="st">"render_fps"</span>: fps}</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> render_mode <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> render_mode <span class="kw">in</span> <span class="va">self</span>.metadata[<span class="st">"render_modes"</span>], render_mode</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.background_color <span class="op">=</span> background_color</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.print_color <span class="op">=</span> print_color</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.show_events <span class="op">=</span> show_events</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fps <span class="op">=</span> <span class="va">self</span>.FPS <span class="op">=</span> fps</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_steps <span class="op">=</span> max_steps</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.steps <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total_steps <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.paused <span class="op">=</span> start_paused</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.increment <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.just_reset <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.render_mode <span class="op">=</span> render_mode</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.screen_size <span class="op">=</span> screen_size <span class="cf">if</span> <span class="bu">isinstance</span>(screen_size, (<span class="bu">tuple</span>, <span class="bu">list</span>)) <span class="cf">else</span> (screen_size, screen_size)</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.width, <span class="va">self</span>.height <span class="op">=</span> <span class="va">self</span>.screen_size</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> <span class="va">self</span>.width</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.screen <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.surf <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._displaying <span class="op">=</span> displaying</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._print <span class="op">=</span> <span class="bu">print</span></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">print</span> <span class="op">=</span> {}</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.show_strings <span class="op">=</span> show_strings</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.show_vars <span class="op">=</span> show_vars</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.show_vars[<span class="st">'FPS'</span>] <span class="op">=</span> <span class="st">'fps'</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.show_vars[<span class="st">'Episode'</span>] <span class="op">=</span> <span class="st">'reset_count'</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.show_vars[<span class="st">'Step'</span>] <span class="op">=</span> <span class="st">'steps'</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.show_vars[<span class="st">'Total Steps'</span>] <span class="op">=</span> <span class="st">'total_steps'</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We want to ensure that reset gets called before step. Nowhere else does this get set to False</span></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._previous_step_called <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._assert_valid_action <span class="op">=</span> assert_valid_action</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._prints_surf <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._original_fps <span class="op">=</span> fps</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._show_help <span class="op">=</span> verbose</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._rendered_helps <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_obs(<span class="va">self</span>):</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_info(<span class="va">self</span>):</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_truncated(<span class="va">self</span>):</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __default_get_terminated(<span class="va">self</span>):</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Called internally so max_steps still works even if _get_terminated is overloaded """</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>        term <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.max_steps <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.max_steps <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.steps <span class="op">&gt;</span> <span class="va">self</span>.max_steps:</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>            term <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_terminated() <span class="kw">or</span> term</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_terminated(<span class="va">self</span>):</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" By default this just terminates after max_steps have been reached """</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_reward(<span class="va">self</span>):</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset(<span class="va">self</span>, seed<span class="op">=</span><span class="va">None</span>, options<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" This sets the self.np_random to use the seed given, resets the steps, and returns the</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a><span class="co">            observation and info. Needs to be called first, if you're depending on self.np_random,</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a><span class="co">            or steps equalling 0, but also needs to return what this returns.</span></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need the following line to seed self.np_random</span></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().reset(seed<span class="op">=</span>seed)</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._reset(seed<span class="op">=</span>seed, options<span class="op">=</span>options)</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.steps <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.just_reset <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_obs(), <span class="va">self</span>._get_info()</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _reset(seed<span class="op">=</span><span class="va">None</span>, options<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span>()</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>, action):</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Call this last, and return it """</span></span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="va">self</span>.reset_count <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"step() called before reset(). reset() must be called first."</span></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's paused, don't bother checking if it's a valid action</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._assert_valid_action <span class="kw">and</span> <span class="kw">not</span> <span class="va">self</span>.paused <span class="kw">or</span> <span class="va">self</span>.increment:</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> <span class="va">self</span>.action_space.contains(action), <span class="st">"Action given not within action_space"</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.paused <span class="kw">and</span> <span class="kw">not</span> <span class="va">self</span>.increment:</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._get_obs(), <span class="va">self</span>._get_reward(), <span class="va">self</span>.__default_get_terminated(), <span class="va">self</span>._get_truncated(), <span class="va">self</span>._get_info()</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._step(action)</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.paused <span class="kw">or</span> <span class="va">self</span>.increment:</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.steps <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.total_steps <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.just_reset <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.increment <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.fps <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.fps <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>._previous_step_called <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sleep for the amount of time until we're supposed to call step next</span></span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>            wait_for <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span><span class="va">self</span>.fps) <span class="op">-</span> (now() <span class="op">-</span> <span class="va">self</span>._previous_step_called)</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If calculations elsewhere took so long that we've already past the next frame time,</span></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>            <span class="co"># don't sleep, just run</span></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> wait_for <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>                sleep(wait_for)</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._previous_step_called <span class="op">=</span> now()</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_obs(), <span class="va">self</span>._get_reward(), <span class="va">self</span>.__default_get_terminated(), <span class="va">self</span>._get_truncated(), <span class="va">self</span>._get_info()</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _step(action):</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span>()</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># @ensure_imported(pygame)</span></span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_pygame(<span class="va">self</span>):</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> pygame</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.screen <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>            pygame.init()</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>            pygame.display.init()</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>            pygame.display.set_caption(<span class="va">self</span>.name)</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.screen <span class="op">=</span> pygame.display.set_mode(<span class="va">self</span>.screen_size)</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.font <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.font <span class="op">=</span> pygame.font.SysFont(<span class="st">"Verdana"</span>, <span class="va">self</span>.FONT_SIZE)</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.surf <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.surf <span class="op">=</span> pygame.Surface(<span class="va">self</span>.screen_size)</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.surf.convert()</span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self.surf.fill((255, 255, 255))</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._prints_surf <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._prints_surf <span class="op">=</span> pygame.Surface(<span class="va">self</span>.screen_size)</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._prints_surf.convert()</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._prints_surf.fill(<span class="va">self</span>.background_color)</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._rendered_helps <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._rendered_helps <span class="op">=</span> [</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.font.render(line, <span class="va">True</span>, <span class="va">self</span>.print_color)</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> line <span class="kw">in</span> <span class="va">self</span>.HELP_TEXT.splitlines()</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> render(<span class="va">self</span>):</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>._displaying:</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._handle_events()</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.render_mode <span class="op">==</span> <span class="st">'pygame'</span>:</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._init_pygame()</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fill the background</span></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.surf.fill(<span class="va">self</span>.background_color)</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.render_pygame()</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The strings in show_strings should come first</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>            strings <span class="op">=</span> <span class="va">self</span>.show_strings.copy()</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the texts from self.show_vars</span></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>            length <span class="op">=</span> <span class="bu">len</span>(<span class="bu">max</span>(<span class="va">self</span>.show_vars.keys(), key<span class="op">=</span><span class="bu">len</span>))</span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>            strings <span class="op">+=</span> [</span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="st">" "</span><span class="op">*</span>(length <span class="op">-</span> <span class="bu">len</span>(name))<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="bu">getattr</span>(<span class="va">self</span>, var, <span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> is not a member"</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> name, var <span class="kw">in</span> <span class="va">self</span>.show_vars.items()</span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._print:</span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add the texts from self.prints</span></span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>                strings <span class="op">+=</span> <span class="bu">list</span>(<span class="va">self</span>.<span class="bu">print</span>.values())</span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw all the text onto the surface</span></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> offset, string <span class="kw">in</span> <span class="bu">enumerate</span>(strings):</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.surf.blit(<span class="va">self</span>.font.render(string, <span class="va">True</span>, <span class="va">self</span>.print_color), (<span class="dv">5</span>, <span class="dv">5</span> <span class="op">+</span> offset<span class="op">*</span>(<span class="va">self</span>.FONT_SIZE <span class="op">+</span> <span class="dv">2</span>)))</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>._show_help:</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> offset, string <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>._rendered_helps):</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>                        max_width <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>._rendered_helps, key<span class="op">=</span><span class="kw">lambda</span> h: h.get_size()[<span class="dv">0</span>]).get_size()[<span class="dv">0</span>]</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.surf.blit(string, (<span class="va">self</span>.width <span class="op">-</span> max_width, offset<span class="op">*</span>(<span class="va">self</span>.FONT_SIZE <span class="op">+</span> <span class="dv">2</span>)))</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If we're not displaying, but still running, show some sort of indication, so they know we haven't frozen</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>._displaying:</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.surf.blit(pygame.font.SysFont(<span class="st">"Verdana"</span>, <span class="dv">25</span>).render(<span class="st">'PAUSED'</span>, <span class="va">True</span>, <span class="va">self</span>.print_color), (<span class="dv">100</span>, <span class="dv">50</span>))</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>            <span class="co"># I don't remember what this does, but I think it's important</span></span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.surf <span class="op">=</span> pygame.transform.scale(<span class="va">self</span>.surf, <span class="va">self</span>.screen_size)</span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Display to screen</span></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.screen.blit(<span class="va">self</span>.surf, (<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._handle_events()</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>            pygame.display.flip()</span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>, <span class="ss">f'render_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>render_mode<span class="sc">}</span><span class="ss">'</span>):</span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>                <span class="bu">getattr</span>(<span class="va">self</span>, <span class="ss">f'render_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>render_mode<span class="sc">}</span><span class="ss">'</span>)()</span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">AttributeError</span>(<span class="ss">f"No render_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>render_mode<span class="sc">}</span><span class="ss"> function provided"</span>)</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> debug_button(<span class="va">self</span>):</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _handle_events(<span class="va">self</span>):</span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e <span class="kw">in</span> pygame.event.get():</span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> e.<span class="bu">type</span>:</span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> pygame.QUIT:</span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.close()</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>                    exit(<span class="dv">0</span>)</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> pygame.KEYDOWN:</span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> e.key <span class="op">==</span> pygame.K_ESCAPE:</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.close()</span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>                        exit(<span class="dv">0</span>)</span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> e.key <span class="op">==</span> pygame.K_SPACE:</span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.paused <span class="op">=</span> <span class="kw">not</span> <span class="va">self</span>.paused</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">match</span> e.<span class="bu">unicode</span>:</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'q'</span>:</span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.close()</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>                            exit(<span class="dv">0</span>)</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'u'</span>:</span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.debug_button()</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'i'</span>:</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.increment <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># If it's not paused, make it paused</span></span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.paused <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'r'</span>:</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.reset()</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'f'</span>:</span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="va">self</span>.fps <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">=</span> <span class="va">self</span>._original_fps</span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">else</span>:</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>._original_fps <span class="op">=</span> <span class="va">self</span>.fps</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'&gt;'</span> <span class="op">|</span> <span class="st">'.'</span>:</span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="va">self</span>.fps <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">=</span> <span class="va">self</span>.FPS_STEP</span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">else</span>:</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">+=</span> <span class="va">self</span>.FPS_STEP</span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'&lt;'</span> <span class="op">|</span> <span class="st">','</span>:</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="va">self</span>.fps <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">else</span>:</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.fps <span class="op">-=</span> <span class="va">self</span>.FPS_STEP</span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'h'</span>:</span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>._show_help <span class="op">=</span> <span class="kw">not</span> <span class="va">self</span>._show_help</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> <span class="st">'d'</span>:</span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>._displaying <span class="op">=</span> <span class="kw">not</span> <span class="va">self</span>._displaying</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">case</span> _:</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.handle_event(e)</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> _:</span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.handle_event(e)</span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.show_events <span class="kw">and</span> e.<span class="bu">type</span> <span class="op">!=</span> pygame.MOUSEMOTION:</span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(e)</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>        pygame.event.pump()</span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> handle_event(<span class="va">self</span>, event):</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> show(<span class="va">self</span>, string):</span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" Sets a given string to be shown on the pygame window """</span></span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.show_strings.append(string)</span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__setitem__</span>(<span class="va">self</span>, index, string):</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">print</span>[index] <span class="op">=</span> string</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> display(<span class="va">self</span>, to<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> IPython.display <span class="im">import</span> HTML, display</span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> to <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>            to.update(HTML(<span class="st">'&lt;br/&gt;'</span>.join(<span class="va">self</span>.show_strings <span class="op">+</span> <span class="bu">list</span>(<span class="va">self</span>.<span class="bu">print</span>.values()))))</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a>            display(HTML(<span class="st">'&lt;br/&gt;'</span>.join(<span class="va">self</span>.show_strings <span class="op">+</span> <span class="bu">list</span>(<span class="va">self</span>.<span class="bu">print</span>.values()))), clear<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> close(<span class="va">self</span>):</span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.screen <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a>            pygame.display.quit()</span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a>            pygame.quit()</span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.screen <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.font <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="code-with-filename">
<details class="code-fold">
<summary>SquareEnv</summary>
<div class="code-with-filename-file">
<pre><strong>SquareEnv2.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gymnasium <span class="im">as</span> gym</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Iterable, Literal</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gymnasium <span class="im">import</span> spaces</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely.geometry <span class="im">as</span> sg</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely.ops <span class="im">as</span> so</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygame</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygame <span class="im">import</span> gfxdraw</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> cos, dist, sin, tan, pi</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> MultiPolygon, Polygon, Point</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.affinity <span class="im">import</span> rotate</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> unary_union</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># from Cope.gym import SimpleGym</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># This is safe to remove if you're using pygame or nothing to render</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiPolygon2Space(multi):</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    rtn <span class="op">=</span> []</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> geom <span class="kw">in</span> multi.geoms:</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the x, y, and rotation angle values for this square</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip the last coordinate, because the first and last are the same</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        corner1, corner2, corner3, corner4, _ <span class="op">=</span> geom.exterior.coords</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        rot_rad <span class="op">=</span> math.atan2(corner4[<span class="dv">1</span>] <span class="op">-</span> corner3[<span class="dv">1</span>], corner4[<span class="dv">0</span>] <span class="op">-</span> corner3[<span class="dv">0</span>])</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize the angles to all be positive (due to our space requirements)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if rot_rad &lt; 0:</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     rot_rad += math.pi/2</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the x, y, and rotation angle values to the result list</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        rtn.append(np.array((</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># x</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            (corner1[<span class="dv">0</span>] <span class="op">+</span> corner2[<span class="dv">0</span>] <span class="op">+</span> corner3[<span class="dv">0</span>] <span class="op">+</span> corner4[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">4</span>,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># y</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            (corner1[<span class="dv">1</span>] <span class="op">+</span> corner2[<span class="dv">1</span>] <span class="op">+</span> corner3[<span class="dv">1</span>] <span class="op">+</span> corner4[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">4</span>,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rotation (radians)</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            rot_rad</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        )))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(rtn)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> space2MultiPolygon(space, side_len<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Autoreshape it if it's flat</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(space.shape) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        space <span class="op">=</span> space.reshape((<span class="bu">int</span>(<span class="bu">len</span>(space)<span class="op">/</span><span class="dv">3</span>), <span class="dv">3</span>))</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return MultiPolygon([Polygon(corners) for corners in compute_corners(space, sideLen=side_len)])</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MultiPolygon(<span class="bu">map</span>(Polygon, compute_all_corners(space, side_len<span class="op">=</span>side_len)))</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_all_corners(squares: List[Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]], side_len<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return np.array([compute_corners(square) for square in squares])</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> s: compute_corners(s, side_len<span class="op">=</span>side_len), squares)))</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_corners(square: Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>], side_len<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> np.ndarray: <span class="co">#[float, float, float, float]:</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotation is in radians</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    x, y, rot <span class="op">=</span> square</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the coordinates of the four corners of the square</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    half <span class="op">=</span> side_len <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        (x <span class="op">+</span> corner[<span class="dv">0</span>]<span class="op">*</span>math.cos(rot) <span class="op">-</span> corner[<span class="dv">1</span>]<span class="op">*</span>math.sin(rot),</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>         y <span class="op">+</span> corner[<span class="dv">0</span>]<span class="op">*</span>math.sin(rot) <span class="op">+</span> corner[<span class="dv">1</span>]<span class="op">*</span>math.cos(rot))</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> corner <span class="kw">in</span> [(half, half), (half, <span class="op">-</span>half), (<span class="op">-</span>half, <span class="op">-</span>half), (<span class="op">-</span>half, half)]</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SquareEnv(SimpleGym):</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args,</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>                 N            <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>                 search_space <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>                 shift_rate   <span class="op">=</span> <span class="fl">.01</span>,</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>                 rot_rate     <span class="op">=</span> <span class="fl">.001</span>,</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  flatten      = False,</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>                 max_steps    <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>                 boundary     <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>                 max_overlap  <span class="op">=</span> <span class="fl">.5</span>,</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                 start_config:Literal[<span class="st">'valid'</span>, <span class="st">'array'</span>, <span class="st">'random'</span>] <span class="op">=</span> <span class="st">'valid'</span>,</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>                 screen_size  <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># mixed is loop the rotation, but clip the position</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>                 bound_method:Literal[<span class="st">'clip'</span>, <span class="st">'loop'</span>, <span class="st">'mixed'</span>] <span class="op">=</span> <span class="st">'mixed'</span>,</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>                 disallow_overlap<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>                 <span class="op">**</span>kwargs,</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>            ):</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" N is the number of boxes</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="co">            search_space is the maximum length of the larger square we're allowing the smaller</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a><span class="co">                squares to be in</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a><span class="co">            shift_rate is the maximum rate at which we can shift the x, y values per step</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="co">            rot_rate is the maximum rate at which we can rotate a box per step</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a><span class="co">            start_config defines we we reset the squares.</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="co">                If `random`, the boxes are randomly placed</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a><span class="co">                If `valid`, the boxes are randomly placed, but not overlapping</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a><span class="co">                If `array`, the boxes are arrayed in a grid, but are randomly "jiggled"</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>args,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            max_steps<span class="op">=</span>max_steps,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            screen_size<span class="op">=</span>screen_size,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>            background_color<span class="op">=</span>(<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>),</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>            print_color<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">'Square Packing'</span>,</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>            show_vars<span class="op">=</span>{<span class="st">'FPS'</span>: <span class="st">'fps'</span>},</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>            assert_valid_action<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>            verbose<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>kwargs</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._show_help <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> search_space <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>            search_space <span class="op">=</span> N</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.render_mode = render_mode</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.search_space <span class="op">=</span> search_space</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.shift_rate <span class="op">=</span> shift_rate</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rot_rate <span class="op">=</span> rot_rate</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.N <span class="op">=</span> N</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.steps = 0</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scale <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.offset <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bound_method <span class="op">=</span> bound_method.lower()</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_overlap <span class="op">=</span> max_overlap</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_steps <span class="op">=</span> max_steps</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.boundary <span class="op">=</span> boundary</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.disallow_overlap <span class="op">=</span> disallow_overlap</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>        size <span class="op">=</span> <span class="va">self</span>.search_space<span class="op">*</span><span class="va">self</span>.scale<span class="op">+</span>(<span class="va">self</span>.offset<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> screen_size <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.screen_size <span class="op">=</span> np.array((size, size))</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.screen = None</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.surf = None</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.extraNums = None</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.userSurf = None</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.userSurfOffset = 0</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self._userPrinted = False</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.font = None</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self._flat = flatten</span></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.start_config <span class="op">=</span> start_config</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movement <span class="op">=</span> np.zeros((<span class="va">self</span>.N, <span class="dv">3</span>))</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.squares: np.ndarray <span class="co"># with the shape (N, 3): it gets flattened/reshaped to interface with the spaces</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>        <span class="co">### Define the spaces </span><span class="al">###</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if self._flat:</span></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.observation_space <span class="op">=</span> spaces.Box(low<span class="op">=</span>np.zeros((N<span class="op">*</span><span class="dv">3</span>,)),</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>            high<span class="op">=</span>np.array([[search_space]<span class="op">*</span>N, [search_space]<span class="op">*</span>N, [math.pi<span class="op">/</span><span class="dv">2</span>]<span class="op">*</span>N]).T.flatten(),</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>            dtype<span class="op">=</span>np.float64, shape<span class="op">=</span>(N<span class="op">*</span><span class="dv">3</span>,))</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The action space is shifting &amp; rotating the squares little bits at a time</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.action_space <span class="op">=</span> spaces.Box(low<span class="op">=</span>np.array([[<span class="op">-</span>shift_rate]<span class="op">*</span>N, [<span class="op">-</span>shift_rate]<span class="op">*</span>N, [<span class="op">-</span>rot_rate]<span class="op">*</span>N]).T.flatten(),</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>            high<span class="op">=</span>np.array([[shift_rate]<span class="op">*</span>N, [shift_rate]<span class="op">*</span>N, [rot_rate]<span class="op">*</span>N]).T.flatten(),</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>            dtype<span class="op">=</span>np.float64, shape<span class="op">=</span>(N<span class="op">*</span><span class="dv">3</span>,))</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># else:</span></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     self.observation_space = spaces.Box(low=np.zeros((N,3)),</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>        <span class="co">#                                         high=np.array([[search_space]*N, [search_space]*N, [math.pi/2]*N]).T,</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">#                                         dtype=np.float64, shape=(N,3))</span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     # The action space is shifting &amp; rotating the squares little bits at a time</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     self.action_space = spaces.Box(low=np.array([[-shift_rate]*N, [-shift_rate]*N, [-rot_rate]*N]).T,</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>        <span class="co">#                                 high=np.array([[shift_rate]*N, [ shift_rate]*N, [ rot_rate]*N]).T,</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>        <span class="co">#                                 dtype=np.float64, shape=(N,3))</span></span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_obs(<span class="va">self</span>):</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.squares.flatten()</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_info(<span class="va">self</span>):</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'Overlaps': not self.squares.is_valid,</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>            <span class="st">'overlap'</span>: <span class="va">self</span>.overlap_area,</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>            <span class="st">'len'</span>: <span class="va">self</span>.side_len,</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>            <span class="st">'wasted'</span>: <span class="va">self</span>.wasted_space,</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 'loss': lossFunc(self.squares),</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_terminated(<span class="va">self</span>):</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optimal: 3.789, best known: 3.877084</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># There's no overlapping and we're better than the previous best</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.N <span class="op">==</span> <span class="dv">11</span> <span class="kw">and</span> <span class="va">self</span>.side_len <span class="op">&lt;</span> <span class="fl">3.877084</span> <span class="kw">and</span> <span class="va">self</span>.is_valid():</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Holy cow, we did it!!!'</span>)</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Coordinates &amp; Rotations:'</span>)</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="va">self</span>.squares)</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'~/SQUARE_PARAMETERS.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>                f.write(<span class="bu">str</span>(<span class="va">self</span>.squares))</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If we're almost entirely overlapping, just kill it</span></span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.overlap_area <span class="op">&gt;</span> <span class="va">self</span>.max_overlap:</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If we're pretty small, and we're only making small adjustments, don't reset, we're doing good!</span></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">any</span>(np.median(<span class="va">self</span>.movement, axis<span class="op">=</span><span class="dv">0</span>)) <span class="kw">and</span> <span class="va">self</span>.side_len <span class="op">&gt;</span> <span class="fl">4.5</span>:</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_reward(<span class="va">self</span>):</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We generally prefer living longer</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">100</span> <span class="co"># Linear</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>        small_side_len <span class="op">=</span> <span class="fl">5.5</span> <span class="co"># Scalar</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>        longevity_importance <span class="op">=</span> <span class="fl">.5</span> <span class="co"># Multiplied</span></span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>        side_importance <span class="op">=</span> <span class="dv">100</span> <span class="co"># Multiplied</span></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>        centered_importance <span class="op">=</span> <span class="dv">0</span> <span class="co"># Exponential</span></span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>        boundary_badness <span class="op">=</span> <span class="dv">0</span> <span class="co"># Linear</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>            boundary_badness <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> <span class="va">self</span>.steps <span class="op">*</span> longevity_importance</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># score -= math.e**(self.side_len * side_importance)</span></span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>        score <span class="op">-=</span> (<span class="va">self</span>.side_len <span class="op">-</span> small_side_len) <span class="op">*</span> side_importance</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We like it if they're in a small area</span></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.side_len <span class="op">&lt;</span> small_side_len <span class="kw">and</span> <span class="va">self</span>.start_config <span class="op">!=</span> <span class="st">'array'</span>:</span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>            score <span class="op">+=</span> <span class="dv">200</span></span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We want to incentivize not touching, instead of disincentivizing touching,</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># because this way it doesn't also disincentivize longer runs</span></span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (if the reward is positive by default (not touching), then a longer run is okay)</span></span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We don't like it when they overlap at all</span></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.overlap_area <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>            score <span class="op">-=</span> <span class="dv">100_000</span></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We really don't like it when they overlap</span></span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>            score <span class="op">-=</span> math.e<span class="op">**</span>(<span class="va">self</span>.overlap_area)</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is essentially a percentage of how much they're overlapping</span></span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># score -= self.overlap_area / (self.N - self.max_overlap)**2</span></span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># I don't want them to just push up against the edges</span></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> boundary_badness <span class="kw">or</span> centered_importance:</span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> x, y, _rot <span class="kw">in</span> <span class="va">self</span>.squares:</span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Left</span></span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> x <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a>                    score <span class="op">-=</span> boundary_badness</span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Top</span></span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> y <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>                    score <span class="op">-=</span> boundary_badness</span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Right</span></span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(x <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>                    score <span class="op">-=</span> boundary_badness</span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Bottom</span></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(y <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>                    score <span class="op">-=</span> boundary_badness</span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>                <span class="co"># We want the squares to be close to the center</span></span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> centered_importance:</span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>                    score <span class="op">-=</span> (math.e <span class="op">**</span> dist([x, y], [<span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>, <span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>]) <span class="op">*</span> centered_importance) <span class="op">/</span> <span class="va">self</span>.N</span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score</span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _step(<span class="va">self</span>, action):</span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The action is given flattened, but self.squares looks like [[x, y, radians], ...]</span></span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> action.shape <span class="op">==</span> (<span class="va">self</span>.N<span class="op">*</span><span class="dv">3</span>,), <span class="ss">f'Action given to step is the wrong shape (Expected shape (</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>N<span class="op">*</span><span class="dv">3</span><span class="sc">}</span><span class="ss">,), got </span><span class="sc">{</span>action<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>        action <span class="op">=</span> action.reshape((<span class="va">self</span>.N,<span class="dv">3</span>))</span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the shifted squares</span></span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>        new_squares <span class="op">=</span> <span class="va">self</span>.squares <span class="op">+</span> action</span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make sure we don't leave the observation space</span></span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.bound_method <span class="op">==</span> <span class="st">'clip'</span>:</span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&gt;</span>  <span class="va">self</span>.search_space] <span class="op">=</span> <span class="va">self</span>.search_space</span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&gt;</span> math.pi<span class="op">/</span><span class="dv">2</span>]          <span class="op">=</span> math.pi<span class="op">/</span><span class="dv">2</span></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.bound_method <span class="op">==</span> <span class="st">'loop'</span>:</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&gt;</span>  <span class="va">self</span>.search_space] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> <span class="va">self</span>.search_space</span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&gt;</span> math.pi<span class="op">/</span><span class="dv">2</span>]          <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> math.pi<span class="op">/</span><span class="dv">2</span></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop the rotation, but clip the position</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.bound_method <span class="op">==</span> <span class="st">'mixed'</span>:</span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&gt;</span>  <span class="va">self</span>.search_space] <span class="op">=</span> <span class="va">self</span>.search_space</span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>            new_squares[:,:<span class="dv">2</span>][new_squares[:,:<span class="dv">2</span>] <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&gt;</span> math.pi<span class="op">/</span><span class="dv">2</span>]          <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>            new_squares[:,<span class="dv">2</span>][new_squares[:,<span class="dv">2</span>]   <span class="op">&lt;</span> <span class="dv">0</span>]                  <span class="op">=</span> math.pi<span class="op">/</span><span class="dv">2</span></span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="ss">f'Unknown `</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>bound_method<span class="sc">}</span><span class="ss">` bound_method provided'</span>)</span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.disallow_overlap:</span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i1, square1 <span class="kw">in</span> <span class="bu">enumerate</span>(new_squares):</span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>                <span class="co"># i1+1, because if a intercets b, then b intersects a. We don't need to check it again</span></span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a>                <span class="co"># We also don't need to check if a intersects a.</span></span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i2, square2 <span class="kw">in</span> <span class="bu">enumerate</span>(new_squares[i1<span class="op">+</span><span class="dv">1</span>:], start<span class="op">=</span>i1<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> Polygon(compute_corners(square1)).intersects(Polygon(compute_corners(square2))):</span>
<span id="cb5-286"><a href="#cb5-286" aria-hidden="true" tabindex="-1"></a>                        new_squares[i1] <span class="op">=</span> <span class="va">self</span>.squares[i1]</span>
<span id="cb5-287"><a href="#cb5-287" aria-hidden="true" tabindex="-1"></a>                        new_squares[i2] <span class="op">=</span> <span class="va">self</span>.squares[i2]</span>
<span id="cb5-288"><a href="#cb5-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-289"><a href="#cb5-289" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movement <span class="op">=</span> <span class="va">self</span>.squares <span class="op">-</span> new_squares</span>
<span id="cb5-290"><a href="#cb5-290" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.squares <span class="op">=</span> new_squares</span>
<span id="cb5-291"><a href="#cb5-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-292"><a href="#cb5-292" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _reset(<span class="va">self</span>, seed<span class="op">=</span><span class="va">None</span>, options<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb5-293"><a href="#cb5-293" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Why does the Space constructor have a seed and not the .sample() method??</span></span>
<span id="cb5-294"><a href="#cb5-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-295"><a href="#cb5-295" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can't be deterministic AND auto start at a valid point</span></span>
<span id="cb5-296"><a href="#cb5-296" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Also make sure we're within the boundaries</span></span>
<span id="cb5-297"><a href="#cb5-297" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> <span class="va">self</span>.start_config:</span>
<span id="cb5-298"><a href="#cb5-298" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">'random'</span>:</span>
<span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.squares <span class="op">=</span> <span class="va">self</span>.observation_space.sample().reshape((<span class="va">self</span>.N, <span class="dv">3</span>))</span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">'valid'</span>:</span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.squares <span class="op">=</span> <span class="va">self</span>.observation_space.sample().reshape((<span class="va">self</span>.N, <span class="dv">3</span>))</span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> <span class="kw">not</span> <span class="va">self</span>.within_boundary <span class="kw">or</span> <span class="kw">not</span> <span class="va">self</span>.is_valid(<span class="va">False</span>):</span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.squares <span class="op">=</span> <span class="va">self</span>.observation_space.sample().reshape((<span class="va">self</span>.N, <span class="dv">3</span>))</span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">'array'</span>:</span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a>                    cols <span class="op">=</span> math.ceil(math.sqrt(<span class="va">self</span>.N))</span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a>                    added <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-307"><a href="#cb5-307" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Minimum so they can't overlap: 1.4142135623730951 (math.sqrt((.5**2)*2) * 2)</span></span>
<span id="cb5-308"><a href="#cb5-308" aria-hidden="true" tabindex="-1"></a>                    gap <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb5-309"><a href="#cb5-309" aria-hidden="true" tabindex="-1"></a>                    startx <span class="op">=</span> <span class="va">self</span>.boundary <span class="op">+</span> gap <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb5-310"><a href="#cb5-310" aria-hidden="true" tabindex="-1"></a>                    starty <span class="op">=</span> <span class="va">self</span>.boundary <span class="op">+</span> gap <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb5-311"><a href="#cb5-311" aria-hidden="true" tabindex="-1"></a>                    squares <span class="op">=</span> []</span>
<span id="cb5-312"><a href="#cb5-312" aria-hidden="true" tabindex="-1"></a>                    x <span class="op">=</span> startx</span>
<span id="cb5-313"><a href="#cb5-313" aria-hidden="true" tabindex="-1"></a>                    y <span class="op">=</span> starty</span>
<span id="cb5-314"><a href="#cb5-314" aria-hidden="true" tabindex="-1"></a>                    col <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-315"><a href="#cb5-315" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> added <span class="op">&lt;</span> <span class="va">self</span>.N:</span>
<span id="cb5-316"><a href="#cb5-316" aria-hidden="true" tabindex="-1"></a>                        squares.append([x, y, random.uniform(<span class="dv">0</span>, math.pi<span class="op">/</span><span class="dv">2</span>)])</span>
<span id="cb5-317"><a href="#cb5-317" aria-hidden="true" tabindex="-1"></a>                        added <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-318"><a href="#cb5-318" aria-hidden="true" tabindex="-1"></a>                        col <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-319"><a href="#cb5-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-320"><a href="#cb5-320" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> col <span class="op">&gt;=</span> cols:</span>
<span id="cb5-321"><a href="#cb5-321" aria-hidden="true" tabindex="-1"></a>                            y <span class="op">+=</span> gap</span>
<span id="cb5-322"><a href="#cb5-322" aria-hidden="true" tabindex="-1"></a>                            x <span class="op">=</span> startx</span>
<span id="cb5-323"><a href="#cb5-323" aria-hidden="true" tabindex="-1"></a>                            col <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-324"><a href="#cb5-324" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb5-325"><a href="#cb5-325" aria-hidden="true" tabindex="-1"></a>                            x <span class="op">+=</span> gap</span>
<span id="cb5-326"><a href="#cb5-326" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.squares <span class="op">=</span> np.array(squares)</span>
<span id="cb5-327"><a href="#cb5-327" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> _:</span>
<span id="cb5-328"><a href="#cb5-328" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ValueError</span>(<span class="st">'Invalid start_config parameter given'</span>)</span>
<span id="cb5-329"><a href="#cb5-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-330"><a href="#cb5-330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-331"><a href="#cb5-331" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This is untested after the refactor</span></span>
<span id="cb5-332"><a href="#cb5-332" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if self._flat:</span></span>
<span id="cb5-333"><a href="#cb5-333" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.squares <span class="op">=</span> spaces.Box(</span>
<span id="cb5-334"><a href="#cb5-334" aria-hidden="true" tabindex="-1"></a>                low  <span class="op">=</span>np.zeros((<span class="va">self</span>.N,<span class="dv">3</span>)),</span>
<span id="cb5-335"><a href="#cb5-335" aria-hidden="true" tabindex="-1"></a>                high <span class="op">=</span>np.array([[<span class="va">self</span>.search_space]<span class="op">*</span><span class="va">self</span>.N, [<span class="va">self</span>.search_space]<span class="op">*</span><span class="va">self</span>.N, [math.pi<span class="op">/</span><span class="dv">2</span>]<span class="op">*</span><span class="va">self</span>.N]).T,</span>
<span id="cb5-336"><a href="#cb5-336" aria-hidden="true" tabindex="-1"></a>                dtype<span class="op">=</span>np.float64,</span>
<span id="cb5-337"><a href="#cb5-337" aria-hidden="true" tabindex="-1"></a>                shape<span class="op">=</span>(<span class="va">self</span>.N,<span class="dv">3</span>),</span>
<span id="cb5-338"><a href="#cb5-338" aria-hidden="true" tabindex="-1"></a>                seed <span class="op">=</span>seed,</span>
<span id="cb5-339"><a href="#cb5-339" aria-hidden="true" tabindex="-1"></a>            ).sample()</span>
<span id="cb5-340"><a href="#cb5-340" aria-hidden="true" tabindex="-1"></a>            <span class="co"># else:</span></span>
<span id="cb5-341"><a href="#cb5-341" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     self.squares = spaces.Box(low=np.zeros((self.N*3,)),</span></span>
<span id="cb5-342"><a href="#cb5-342" aria-hidden="true" tabindex="-1"></a>            <span class="co">#                     high=np.array([[self.search_space]*self.N, [self.search_space]*self.N, [math.pi/2]*self.N]).T.flatten(),</span></span>
<span id="cb5-343"><a href="#cb5-343" aria-hidden="true" tabindex="-1"></a>            <span class="co">#                     dtype=np.float64, shape=(self.N*3,), seed=seed).sample().reshape((self.N, 3))</span></span>
<span id="cb5-344"><a href="#cb5-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-345"><a href="#cb5-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-346"><a href="#cb5-346" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_valid(<span class="va">self</span>, shallow<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb5-347"><a href="#cb5-347" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" True if there's no overlapping """</span></span>
<span id="cb5-348"><a href="#cb5-348" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (shallow <span class="kw">and</span> <span class="va">self</span>.disallow_overlap) <span class="kw">or</span> space2MultiPolygon(<span class="va">self</span>.squares).is_valid</span>
<span id="cb5-349"><a href="#cb5-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-350"><a href="#cb5-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb5-351"><a href="#cb5-351" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> overlap_area(<span class="va">self</span>):</span>
<span id="cb5-352"><a href="#cb5-352" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.disallow_overlap:</span>
<span id="cb5-353"><a href="#cb5-353" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb5-354"><a href="#cb5-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-355"><a href="#cb5-355" aria-hidden="true" tabindex="-1"></a>        area <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-356"><a href="#cb5-356" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for i, square1 in enumerate(self.squares.geoms):</span></span>
<span id="cb5-357"><a href="#cb5-357" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for square2 in list(self.squares.geoms)[i+1:]:</span></span>
<span id="cb5-358"><a href="#cb5-358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> square1, square2 <span class="kw">in</span> itertools.combinations(<span class="va">self</span>.squares, <span class="dv">2</span>):</span>
<span id="cb5-359"><a href="#cb5-359" aria-hidden="true" tabindex="-1"></a>            area <span class="op">+=</span> Polygon(compute_corners(square1)).intersection(Polygon(compute_corners(square2))).area</span>
<span id="cb5-360"><a href="#cb5-360" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> area</span>
<span id="cb5-361"><a href="#cb5-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-362"><a href="#cb5-362" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> min_rotated_rect_extents(<span class="va">self</span>, side_len<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> Tuple[<span class="st">'minx'</span>, <span class="st">'miny'</span>, <span class="st">'maxx'</span>, <span class="st">'maxy'</span>]:</span>
<span id="cb5-363"><a href="#cb5-363" aria-hidden="true" tabindex="-1"></a>        corners <span class="op">=</span> compute_all_corners(<span class="va">self</span>.squares)</span>
<span id="cb5-364"><a href="#cb5-364" aria-hidden="true" tabindex="-1"></a>        xs <span class="op">=</span> corners[:,:,<span class="dv">0</span>]</span>
<span id="cb5-365"><a href="#cb5-365" aria-hidden="true" tabindex="-1"></a>        ys <span class="op">=</span> corners[:,:,<span class="dv">1</span>]</span>
<span id="cb5-366"><a href="#cb5-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">min</span>(xs), np.<span class="bu">min</span>(ys), np.<span class="bu">max</span>(xs), np.<span class="bu">max</span>(ys)</span>
<span id="cb5-367"><a href="#cb5-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-368"><a href="#cb5-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb5-369"><a href="#cb5-369" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> side_len(<span class="va">self</span>):</span>
<span id="cb5-370"><a href="#cb5-370" aria-hidden="true" tabindex="-1"></a>        <span class="co"># minx = np.min(self.squares[])</span></span>
<span id="cb5-371"><a href="#cb5-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x, y = self.squares.minimum_rotated_rectangle.exterior.coords.xy</span></span>
<span id="cb5-372"><a href="#cb5-372" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> <span class="va">self</span>.min_rotated_rect_extents()</span>
<span id="cb5-373"><a href="#cb5-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(maxx <span class="op">-</span> minx, maxy <span class="op">-</span> miny)</span>
<span id="cb5-374"><a href="#cb5-374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># edge_length = (Point(x[0], y[0]).distance(Point(x[1], y[1])), Point(x[1], y[1]).distance(Point(x[2], y[2])))</span></span>
<span id="cb5-375"><a href="#cb5-375" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return max(edge_length)</span></span>
<span id="cb5-376"><a href="#cb5-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-377"><a href="#cb5-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb5-378"><a href="#cb5-378" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wasted_space(<span class="va">self</span>):</span>
<span id="cb5-379"><a href="#cb5-379" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.side_len<span class="op">**</span><span class="dv">2</span> <span class="op">-</span> <span class="va">self</span>.N</span>
<span id="cb5-380"><a href="#cb5-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-381"><a href="#cb5-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb5-382"><a href="#cb5-382" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> within_boundary(<span class="va">self</span>):</span>
<span id="cb5-383"><a href="#cb5-383" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-384"><a href="#cb5-384" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-385"><a href="#cb5-385" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x, y, rot <span class="kw">in</span> <span class="va">self</span>.squares:</span>
<span id="cb5-386"><a href="#cb5-386" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (x <span class="op">&lt;</span> <span class="va">self</span>.boundary <span class="kw">or</span></span>
<span id="cb5-387"><a href="#cb5-387" aria-hidden="true" tabindex="-1"></a>                y <span class="op">&lt;</span> <span class="va">self</span>.boundary <span class="kw">or</span></span>
<span id="cb5-388"><a href="#cb5-388" aria-hidden="true" tabindex="-1"></a>                <span class="bu">abs</span>(x <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary <span class="kw">or</span></span>
<span id="cb5-389"><a href="#cb5-389" aria-hidden="true" tabindex="-1"></a>                <span class="bu">abs</span>(y <span class="op">-</span> <span class="va">self</span>.search_space) <span class="op">&lt;</span> <span class="va">self</span>.boundary</span>
<span id="cb5-390"><a href="#cb5-390" aria-hidden="true" tabindex="-1"></a>            ): <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb5-391"><a href="#cb5-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-392"><a href="#cb5-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-393"><a href="#cb5-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-394"><a href="#cb5-394" aria-hidden="true" tabindex="-1"></a>    <span class="co"># def render_matplotlib(self):</span></span>
<span id="cb5-395"><a href="#cb5-395" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.gca().set_aspect('equal')</span></span>
<span id="cb5-396"><a href="#cb5-396" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for geom in self.squares.geoms:</span></span>
<span id="cb5-397"><a href="#cb5-397" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     xs, ys = geom.exterior.xy</span></span>
<span id="cb5-398"><a href="#cb5-398" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     plt.fill(xs, ys, alpha=0.5, fc='r', ec='none')</span></span>
<span id="cb5-399"><a href="#cb5-399" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb5-400"><a href="#cb5-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-401"><a href="#cb5-401" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> render_shapely(<span class="va">self</span>):</span>
<span id="cb5-402"><a href="#cb5-402" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self._display_id.update(space2MultiPolygon(self.squares))</span></span>
<span id="cb5-403"><a href="#cb5-403" aria-hidden="true" tabindex="-1"></a>        display(space2MultiPolygon(<span class="va">self</span>.squares), clear<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-404"><a href="#cb5-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-405"><a href="#cb5-405" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> render_pygame(<span class="va">self</span>):</span>
<span id="cb5-406"><a href="#cb5-406" aria-hidden="true" tabindex="-1"></a>        scaled_squares <span class="op">=</span> <span class="va">self</span>.squares.copy()</span>
<span id="cb5-407"><a href="#cb5-407" aria-hidden="true" tabindex="-1"></a>        scaled_squares[:,:<span class="dv">2</span>] <span class="op">*=</span> <span class="va">self</span>.scale</span>
<span id="cb5-408"><a href="#cb5-408" aria-hidden="true" tabindex="-1"></a>        scaled_squares[:,:<span class="dv">2</span>] <span class="op">+=</span> <span class="va">self</span>.offset</span>
<span id="cb5-409"><a href="#cb5-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-410"><a href="#cb5-410" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw all the polygons</span></span>
<span id="cb5-411"><a href="#cb5-411" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> square <span class="kw">in</span> compute_all_corners(scaled_squares, side_len<span class="op">=</span><span class="va">self</span>.scale):</span>
<span id="cb5-412"><a href="#cb5-412" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(square)</span></span>
<span id="cb5-413"><a href="#cb5-413" aria-hidden="true" tabindex="-1"></a>            pygame.draw.polygon(<span class="va">self</span>.surf, (<span class="dv">200</span>, <span class="dv">45</span>, <span class="dv">45</span>, <span class="dv">175</span>), square)</span>
<span id="cb5-414"><a href="#cb5-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-415"><a href="#cb5-415" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the bounding box of the squares</span></span>
<span id="cb5-416"><a href="#cb5-416" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> <span class="va">self</span>.min_rotated_rect_extents(side_len<span class="op">=</span><span class="va">self</span>.scale)</span>
<span id="cb5-417"><a href="#cb5-417" aria-hidden="true" tabindex="-1"></a>        corners <span class="op">=</span> np.array([</span>
<span id="cb5-418"><a href="#cb5-418" aria-hidden="true" tabindex="-1"></a>            [minx, miny],</span>
<span id="cb5-419"><a href="#cb5-419" aria-hidden="true" tabindex="-1"></a>            [minx, maxy],</span>
<span id="cb5-420"><a href="#cb5-420" aria-hidden="true" tabindex="-1"></a>            [maxx, maxy],</span>
<span id="cb5-421"><a href="#cb5-421" aria-hidden="true" tabindex="-1"></a>            [maxx, miny],</span>
<span id="cb5-422"><a href="#cb5-422" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb5-423"><a href="#cb5-423" aria-hidden="true" tabindex="-1"></a>        gfxdraw.polygon(<span class="va">self</span>.surf, (corners<span class="op">*</span><span class="va">self</span>.scale)<span class="op">+</span><span class="va">self</span>.offset, (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb5-424"><a href="#cb5-424" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the search space</span></span>
<span id="cb5-425"><a href="#cb5-425" aria-hidden="true" tabindex="-1"></a>        gfxdraw.rectangle(<span class="va">self</span>.surf, (<span class="va">self</span>.offset, <span class="va">self</span>.offset, <span class="va">self</span>.search_space<span class="op">*</span><span class="va">self</span>.scale, <span class="va">self</span>.search_space<span class="op">*</span><span class="va">self</span>.scale), (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb5-426"><a href="#cb5-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-427"><a href="#cb5-427" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the boundaries</span></span>
<span id="cb5-428"><a href="#cb5-428" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.boundary:</span>
<span id="cb5-429"><a href="#cb5-429" aria-hidden="true" tabindex="-1"></a>            boundsColor <span class="op">=</span> (<span class="dv">210</span>, <span class="dv">95</span>, <span class="dv">79</span>, <span class="dv">100</span>)</span>
<span id="cb5-430"><a href="#cb5-430" aria-hidden="true" tabindex="-1"></a>            off <span class="op">=</span> <span class="va">self</span>.offset</span>
<span id="cb5-431"><a href="#cb5-431" aria-hidden="true" tabindex="-1"></a>            b <span class="op">=</span> <span class="va">self</span>.boundary <span class="op">*</span> <span class="va">self</span>.scale</span>
<span id="cb5-432"><a href="#cb5-432" aria-hidden="true" tabindex="-1"></a>            ss <span class="op">=</span> <span class="va">self</span>.search_space <span class="op">*</span> <span class="va">self</span>.scale</span>
<span id="cb5-433"><a href="#cb5-433" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Top</span></span>
<span id="cb5-434"><a href="#cb5-434" aria-hidden="true" tabindex="-1"></a>            gfxdraw.box(<span class="va">self</span>.surf, ((off, off), (ss<span class="op">-</span>b<span class="op">-</span><span class="dv">1</span>, b)), boundsColor)</span>
<span id="cb5-435"><a href="#cb5-435" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Right</span></span>
<span id="cb5-436"><a href="#cb5-436" aria-hidden="true" tabindex="-1"></a>            gfxdraw.box(<span class="va">self</span>.surf, ((off<span class="op">+</span>ss, off), (<span class="op">-</span>b, ss<span class="op">-</span>b)), boundsColor)</span>
<span id="cb5-437"><a href="#cb5-437" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Left</span></span>
<span id="cb5-438"><a href="#cb5-438" aria-hidden="true" tabindex="-1"></a>            gfxdraw.box(<span class="va">self</span>.surf, ((off<span class="op">+</span>b, off<span class="op">+</span>b), (<span class="op">-</span>b, ss<span class="op">-</span>b)), boundsColor)</span>
<span id="cb5-439"><a href="#cb5-439" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Bottom</span></span>
<span id="cb5-440"><a href="#cb5-440" aria-hidden="true" tabindex="-1"></a>            gfxdraw.box(<span class="va">self</span>.surf, ((off<span class="op">+</span>b<span class="op">+</span><span class="dv">1</span>, off<span class="op">+</span>ss<span class="op">-</span>b), (ss<span class="op">-</span>b, b)), boundsColor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="the-script" class="level2">
<h2 class="anchored" data-anchor-id="the-script">The Script</h2>
<p>This is the actual script that I used, with annotations</p>
<section id="dependancies" class="level3">
<h3 class="anchored" data-anchor-id="dependancies">Dependancies</h3>
<p>To set up Tensorflow with hardware acceleration, see <a href="https://smartycope.org/posts/InstallingTensorflow/">this blog post</a> I wrote for this project specifically. All the versions and hardware are what I used for running this project.</p>
<div id="cell-14" class="cell">
<details class="code-fold">
<summary>Install dependancies</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python 3.11.9</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install <span class="op">\</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    gymnasium<span class="op">==</span><span class="fl">0.29.1</span> <span class="op">\</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    numpy<span class="op">==</span><span class="fl">1.26.4</span> <span class="op">\</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    tensorflow<span class="op">==</span><span class="fl">2.14.0</span> <span class="op">\</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    matplotlib<span class="op">==</span><span class="fl">3.9.0</span> <span class="op">\</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    pygame<span class="op">==</span><span class="fl">2.5.2</span> <span class="op">\</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    shapely<span class="op">==</span><span class="fl">2.0.4</span> <span class="op">\</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    pydot<span class="op">==</span><span class="fl">2.0.0</span> <span class="op">\</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    graphviz<span class="op">==</span><span class="fl">0.20.3</span> <span class="op">\</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    rich<span class="op">==</span><span class="fl">13.7.1</span> <span class="op">\</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    pillow<span class="op">==</span><span class="fl">10.3.0</span> <span class="op">\</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ipykernel<span class="op">==</span><span class="fl">6.29.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-15" class="cell">
<details class="code-fold">
<summary>Imports</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gymnasium <span class="im">as</span> gym</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras <span class="im">as</span> ks</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> layers</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span> <span class="im">as</span> rprint</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML, display</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="configuration-enviorment" class="level3">
<h3 class="anchored" data-anchor-id="configuration-enviorment">Configuration &amp; Enviorment</h3>
<div id="cell-17" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of setting the envioronment up as a local package, which seems to be the standard,</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I just import directly from the file</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> SquareEnv(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 11 Squares</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    N<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is the size of the area the squares are allowed to be in</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is in "atomic units". Pixels, except everything is scaled up a ton so we can see it.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    search_space<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    render_mode<span class="op">=</span><span class="st">"pygame"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># How maximum reate at which we translate and rotate the squares per step</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    shift_rate<span class="op">=</span><span class="fl">.05</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    rot_rate<span class="op">=</span><span class="fl">.03</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The maximum amount of steps the enviornment can last for, before it resets itself</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    max_steps<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This defines what to do if a squares goes outside the search space:</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clip: rotation and position stay the same if they try to go out</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop: rotation and position loop back to the other end if they try to go out</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mixed: loop the rotation, but clip the position</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    bound_method<span class="op">=</span><span class="st">'mixed'</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Whether we allow the squares to overlap or not</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># At first, I figured allowing overlap, but having a steep cost to squares overlaping would help</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># because when the squares get packed too tight, they can just overlap to a different state,</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># instead of having to back out and come back in, valid all the time</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I'm unsure which is better, to be honest, but disallowing overlap made tuning the reward</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># function a little easier</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    disallow_overlap<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The width of the areas on the sides of the search space that decrease the reward for each</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># square in it</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    boundary<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># How much area we're allowed to overlap before we reset the episode (in units of "pixels"^2</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (see above))</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    max_overlap<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This defines we we reset the squares.</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># random: the squares are randomly placed</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># valid: the squares are randomly placed, but not overlapping</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># array: the squares are arrayed in a grid, but are randomly "jiggled"</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    start_config<span class="op">=</span><span class="st">'array'</span>,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    screen_size<span class="op">=</span>(<span class="dv">300</span>, <span class="dv">500</span>),</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>num_states <span class="op">=</span> np.product(env.observation_space.shape)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size of State Space -&gt; </span><span class="sc">{</span>num_states<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>num_actions <span class="op">=</span> np.product(env.action_space.shape)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size of Action Space -&gt; </span><span class="sc">{</span>num_actions<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>upper_bound <span class="op">=</span> env.action_space.high</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>lower_bound <span class="op">=</span> env.action_space.low</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max Value of an Action -&gt;"</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>display(upper_bound)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Min Value of an Action -&gt;"</span>)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>display(lower_bound)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Size of State Space -&gt; 33
Size of Action Space -&gt; 33
Max Value of an Action -&gt;
Min Value of an Action -&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>array([0.05, 0.05, 0.03, 0.05, 0.05, 0.03, 0.05, 0.05, 0.03, 0.05, 0.05,
       0.03, 0.05, 0.05, 0.03, 0.05, 0.05, 0.03, 0.05, 0.05, 0.03, 0.05,
       0.05, 0.03, 0.05, 0.05, 0.03, 0.05, 0.05, 0.03, 0.05, 0.05, 0.03])</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>array([-0.05, -0.05, -0.03, -0.05, -0.05, -0.03, -0.05, -0.05, -0.03,
       -0.05, -0.05, -0.03, -0.05, -0.05, -0.03, -0.05, -0.05, -0.03,
       -0.05, -0.05, -0.03, -0.05, -0.05, -0.03, -0.05, -0.05, -0.03,
       -0.05, -0.05, -0.03, -0.05, -0.05, -0.03])</code></pre>
</div>
</div>
</section>
<section id="ddpg-buffer" class="level3">
<h3 class="anchored" data-anchor-id="ddpg-buffer">DDPG Buffer</h3>
<p>This is the code buffer. It’s the main engine of the DDPG algorithm. It’s minorly modified from some place on the internet I can’t find anymore. I used to be linked to <a href="https://spinningup.openai.com/en/latest/algorithms/ddpg.html">this tutorial</a>, which is where I learned the DDPG concepts from</p>
<div id="cell-19" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Buffer</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Buffer:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, buffer_capacity<span class="op">=</span><span class="dv">100000</span>, batch_size<span class="op">=</span><span class="dv">64</span>):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Number of "experiences" to store at max</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.buffer_capacity <span class="op">=</span> buffer_capacity</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Num of tuples to train on.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> batch_size</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Its tells us num of times record() was called.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.buffer_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instead of list of tuples as the exp.replay concept go</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We use different np.arrays for each tuple element</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_buffer <span class="op">=</span> np.zeros((<span class="va">self</span>.buffer_capacity, num_states))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.action_buffer <span class="op">=</span> np.zeros((<span class="va">self</span>.buffer_capacity, num_actions))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reward_buffer <span class="op">=</span> np.zeros((<span class="va">self</span>.buffer_capacity, <span class="dv">1</span>))</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.next_state_buffer <span class="op">=</span> np.zeros((<span class="va">self</span>.buffer_capacity, num_states))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Takes (s,a,r,s') obervation tuple as input</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> record(<span class="va">self</span>, state, action, reward, next_state):</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set index to zero if buffer_capacity is exceeded, replacing old records</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> <span class="va">self</span>.buffer_counter <span class="op">%</span> <span class="va">self</span>.buffer_capacity</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_buffer[index] <span class="op">=</span> state</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.action_buffer[index] <span class="op">=</span> action</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reward_buffer[index] <span class="op">=</span> reward</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.next_state_buffer[index] <span class="op">=</span> next_state</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.buffer_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Eager execution is turned on by default in TensorFlow 2. Decorating with tf.function allows</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TensorFlow to build a static graph out of the logic and computations in our function.</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This provides a large speed up for blocks of code that contain many small TensorFlow</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># operations such as this one.</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@tf.function</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(<span class="va">self</span>, state_batch, action_batch, reward_batch, next_state_batch):</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('update called')</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training and updating Actor &amp; Critic networks.</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># What we think we should do</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>            target_actions <span class="op">=</span> target_actor(next_state_batch, training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># How good we think that is (the target Q-Network)</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            target_evaluation <span class="op">=</span> target_critic([next_state_batch, target_actions], training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> reward_batch <span class="op">+</span> gamma <span class="op">*</span> target_evaluation</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>            critic_value <span class="op">=</span> critic_model([state_batch, action_batch], training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the average amount we were off by in predicting how well we would do, squared,</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># and that's the loss</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>            critic_loss <span class="op">=</span> tf.math.reduce_mean(tf.math.square(y <span class="op">-</span> critic_value))</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        critic_grad <span class="op">=</span> tape.gradient(critic_loss, critic_model.trainable_variables)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Added Gradient clipping on this line</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        clipped_grad <span class="op">=</span> [tf.clip_by_value(grad, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="cf">for</span> grad <span class="kw">in</span> critic_grad]</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        critic_optimizer.apply_gradients(<span class="bu">zip</span>(clipped_grad, critic_model.trainable_variables))</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>            actions <span class="op">=</span> actor_model(state_batch, training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            critic_value <span class="op">=</span> critic_model([state_batch, actions], training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Used `-value` as we want to maximize the value given by the critic for our actions</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            actor_loss <span class="op">=</span> <span class="op">-</span>tf.math.reduce_mean(critic_value)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        actor_grad <span class="op">=</span> tape.gradient(actor_loss, actor_model.trainable_variables)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        actor_optimizer.apply_gradients(<span class="bu">zip</span>(actor_grad, actor_model.trainable_variables))</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> actor_loss, critic_loss</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We compute the loss and update parameters</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> learn(<span class="va">self</span>):</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get sampling range</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        record_range <span class="op">=</span> <span class="bu">min</span>(<span class="va">self</span>.buffer_counter, <span class="va">self</span>.buffer_capacity)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Randomly sample indices</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>        batch_indices <span class="op">=</span> np.random.choice(record_range, <span class="va">self</span>.batch_size)</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to tensors</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        state_batch <span class="op">=</span> tf.convert_to_tensor(<span class="va">self</span>.state_buffer[batch_indices])</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        action_batch <span class="op">=</span> tf.convert_to_tensor(<span class="va">self</span>.action_buffer[batch_indices])</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        reward_batch <span class="op">=</span> tf.convert_to_tensor(<span class="va">self</span>.reward_buffer[batch_indices])</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        reward_batch <span class="op">=</span> tf.cast(reward_batch, dtype<span class="op">=</span>tf.float32)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        next_state_batch <span class="op">=</span> tf.convert_to_tensor(<span class="va">self</span>.next_state_buffer[batch_indices])</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.update(state_batch, action_batch, reward_batch, next_state_batch)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="co"># This updates target parameters slowly</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on rate `tau`, which is much less than one.</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_target(target_weights, weights, tau):</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (a, b) <span class="kw">in</span> <span class="bu">zip</span>(target_weights, weights):</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>        a.assign(b <span class="op">*</span> tau <span class="op">+</span> a <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> tau))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="define-actor-critic-models" class="level3">
<h3 class="anchored" data-anchor-id="define-actor-critic-models">Define Actor &amp; Critic Models</h3>
<p>These are the main actor and critic neural nets</p>
<div id="cell-21" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tells a later cell to reset the weights (since we might have changed how we initialize them in</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this cell)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>INIT_WEIGHTS <span class="op">=</span> <span class="va">False</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>reg_str <span class="op">=</span> <span class="fl">.01</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_actor():</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize weights</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last_init = tf.random_uniform_initializer(minval=-env.shift_rate, maxval=env.shift_rate)</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last_init = tf.random_uniform_initializer(minval=-3e-3, maxval=3e-3)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> layers.Input(shape<span class="op">=</span>(num_states,))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">750</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(inputs)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">1024</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(out)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expiremented with making this layer have an exponential activation function</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">512</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(out)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(out)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">256</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(out)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># outputs = layers.Dense(num_actions, activation='softsign', kernel_initializer=last_init)(out)</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> layers.Dense(num_actions, activation<span class="op">=</span><span class="st">'tanh'</span>)(out)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is rescale the output from between -1 - 1 to the appropriate action space scale</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> outputs <span class="op">*</span> upper_bound</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> tf.keras.Model(inputs, outputs)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_critic():</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># State as input</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    state_input <span class="op">=</span> layers.Input(shape<span class="op">=</span>(num_states,))</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    state_out <span class="op">=</span> layers.Dense(<span class="dv">16</span>, activation<span class="op">=</span><span class="st">"tanh"</span>)(state_input)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    state_out <span class="op">=</span> layers.Dense(<span class="dv">32</span>, activation<span class="op">=</span><span class="st">"tanh"</span>)(state_out)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Action as input</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    action_input <span class="op">=</span> layers.Input(shape<span class="op">=</span>(num_actions,))</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    action_out <span class="op">=</span> layers.Dense(<span class="dv">32</span>, activation<span class="op">=</span><span class="st">"tanh"</span>)(action_input)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Both are passed through seperate layer before concatenating</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    concat <span class="op">=</span> layers.Concatenate()([state_out, action_out])</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">1024</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(concat)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">512</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(concat)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(concat)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> layers.Dense(<span class="dv">256</span>, activation<span class="op">=</span><span class="st">"tanh"</span>, kernel_regularizer<span class="op">=</span>ks.regularizers.l2(reg_str))(out)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> layers.Dense(<span class="dv">1</span>)(out)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outputs single value for give state-action</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> tf.keras.Model([state_input, action_input], outputs)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Weights Handling</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>actor_weights_file <span class="op">=</span> <span class="st">'actor_weights'</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>critic_weights_file <span class="op">=</span> <span class="st">'critic_weights'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>target_actor_weights_file <span class="op">=</span> <span class="st">'target_actor_weights'</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>target_critic_weights_file <span class="op">=</span> <span class="st">'target_critic_weights'</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>load_weights <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>load_target_weights <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Initialize the actor and critic models</p>
<div id="cell-24" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>actor_model <span class="op">=</span> get_actor()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>critic_model <span class="op">=</span> get_critic()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>target_actor <span class="op">=</span> get_actor()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>target_critic <span class="op">=</span> get_critic()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>More Weights Handling</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> load_weights:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    actor_model.load_weights(actor_weights_file)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    critic_model.load_weights(critic_weights_file)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> load_target_weights:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    target_actor.load_weights(target_actor_weights_file)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    target_critic.load_weights(target_critic_weights_file)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Making the weights equal initially</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    target_actor.set_weights(actor_model.get_weights())</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    target_critic.set_weights(critic_model.get_weights())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameters">Hyperparameters</h3>
<p>These are some of the easily tunable hyperparameters</p>
<div id="cell-27" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Learning rate for actor-critic models</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Previously: .002</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>critic_lr <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Previously: .0015</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>actor_lr <span class="op">=</span> <span class="fl">0.0003</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>critic_optimizer <span class="op">=</span> tf.keras.optimizers.Adam(critic_lr)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>actor_optimizer <span class="op">=</span> tf.keras.optimizers.Adam(actor_lr)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># How many resets we're running for.</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>total_episodes <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Discount factor for future rewards</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>patience <span class="op">=</span> gamma <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Used to update target networks</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>tau <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>avg_reward_episodes <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># This used to be a custom OUActionNoise class, but then a paper came out saying that</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co"># gaussian noise works just as well</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>std_dev <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> <span class="kw">lambda</span> mu<span class="op">=</span><span class="dv">0</span>, std_dev<span class="op">=</span>std_dev: random.gauss(mu, std_dev)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>add_noise <span class="op">=</span> <span class="va">True</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>noise_cooldown <span class="op">=</span> actor_lr <span class="op">*</span> <span class="dv">4</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> Buffer(<span class="dv">10000</span>, batch_size<span class="op">=</span><span class="dv">64</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>reset_weights <span class="op">=</span> <span class="va">False</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>reset_weights_once <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Load Weights</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> INIT_WEIGHTS:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    actor_model.save_weights(<span class="st">'actor_model_init.h5'</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    critic_model.save_weights(<span class="st">'critic_model_init.h5'</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    target_actor.save_weights(<span class="st">'target_actor_init.h5'</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    target_critic.save_weights(<span class="st">'target_critic_init.h5'</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    INIT_WEIGHTS <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-29" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Show our configuration in the window</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>env.show_strings <span class="op">=</span> [</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ML Config:'</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'gamma: </span><span class="sc">{</span>gamma<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'tau: </span><span class="sc">{</span>tau<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Buffer Capacity: </span><span class="sc">{</span><span class="bu">buffer</span><span class="sc">.</span>buffer_capacity<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Buffer Batch Size: </span><span class="sc">{</span><span class="bu">buffer</span><span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># f'avg of prev: {avg_reward_episodes}',</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'-------------------------'</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Env Config:'</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Number of Squares: </span><span class="sc">{</span>env<span class="sc">.</span>N<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Max Steps: </span><span class="sc">{</span>env<span class="sc">.</span>max_steps<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Max Overlap: </span><span class="sc">{</span>env<span class="sc">.</span>max_overlap<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Shift Rate: </span><span class="sc">{</span>env<span class="sc">.</span>shift_rate<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Rotation Rate: </span><span class="sc">{</span>env<span class="sc">.</span>rot_rate<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Start Config: </span><span class="sc">{</span>env<span class="sc">.</span>start_config<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Boundary: </span><span class="sc">{</span>env<span class="sc">.</span>boundary<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Bound Method: </span><span class="sc">{</span>env<span class="sc">.</span>bound_method<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'-------------------------'</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-30" class="cell">
<details class="code-fold">
<summary>A function to save all the information from the runs</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_output(captured, run_name):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dir</span> <span class="op">=</span> Path(<span class="st">'runs'</span>) <span class="op">/</span> run_name</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    (<span class="bu">dir</span> <span class="op">/</span> <span class="st">'weights'</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the outputs</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> (</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'config.html'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EpisodeRewardGraph.png'</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'LossesGraph.png'</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'BestState.svg'</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'actor_pretty.png'</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'critic_pretty.png'</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> output, name <span class="kw">in</span> <span class="bu">zip</span>(captured.outputs, names):</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="bu">dir</span> <span class="op">/</span> name, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'text/html'</span> <span class="kw">in</span> output.data:</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                f.write(<span class="bu">str</span>(output.data[<span class="st">'text/html'</span>]).encode())</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'image/png'</span> <span class="kw">in</span> output.data:</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                f.write(base64.decodebytes(<span class="bu">bytes</span>(output.data[<span class="st">'image/png'</span>], <span class="st">"utf-8"</span>)))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'image/svg+xml'</span> <span class="kw">in</span> output.data:</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                f.write(output.data[<span class="st">'image/svg+xml'</span>].encode())</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> (<span class="bu">dir</span> <span class="op">/</span> <span class="st">'best.txt'</span>).<span class="bu">open</span>(<span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        f.write(captured.stdout)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> (<span class="bu">dir</span> <span class="op">/</span> <span class="st">'reward_func.py'</span>).<span class="bu">open</span>(<span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        f.write(inspect.getsource(env._get_reward))</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the weights</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    actor_model.save_weights(<span class="bu">dir</span> <span class="op">/</span> <span class="st">'weights'</span> <span class="op">/</span> <span class="st">'actor_weights'</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    critic_model.save_weights(<span class="bu">dir</span> <span class="op">/</span> <span class="st">'weights'</span> <span class="op">/</span> <span class="st">'critic_weights'</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    target_actor.save_weights(<span class="bu">dir</span> <span class="op">/</span> <span class="st">'weights'</span> <span class="op">/</span> <span class="st">'target_actor_weights'</span>)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    target_critic.save_weights(<span class="bu">dir</span> <span class="op">/</span> <span class="st">'weights'</span> <span class="op">/</span> <span class="st">'target_critic_weights'</span>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>disp <span class="op">=</span> display(<span class="st">''</span>, display_id<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="main-loop" class="level3">
<h3 class="anchored" data-anchor-id="main-loop">Main Loop</h3>
<p>This is the loop that actually runs the RL agent in the enviornment</p>
<p>Using the cell above and some cell magic, this logs everything to a directory, so all the information is saved and reproducible</p>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture run</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#! REMEMBER: Don't forget to increment the run name</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> reset_weights <span class="kw">or</span> reset_weights_once:</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    actor_model.load_weights(<span class="st">'actor_model_init.h5'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    critic_model.load_weights(<span class="st">'critic_model_init.h5'</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    target_actor.load_weights(<span class="st">'target_actor_init.h5'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    target_critic.load_weights(<span class="st">'target_critic_init.h5'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    reset_weights_once <span class="op">=</span> <span class="va">False</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># To store reward history of each episode (for plotting)</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ep_reward_list <span class="op">=</span> []</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># To store average reward history of last few episodes (for plotting)</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>avg_reward_list <span class="op">=</span> []</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># These aren't used in the algorithm, they're just so I can make graphs to see what is going on</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>ep_len_list <span class="op">=</span> [] <span class="co"># To store the length of of each episode</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>ep_critic_loss <span class="op">=</span> []</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>ep_actor_loss <span class="op">=</span> []</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time_ns()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>best_state_yet <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>best_reward_yet <span class="op">=</span> <span class="op">-</span><span class="dv">10000000000</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run through `total_episodes` number of enviorment resets</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ep <span class="kw">in</span> <span class="bu">range</span>(total_episodes):</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset the enviornment</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        prev_state, _ <span class="op">=</span> env.reset()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The env.search_space here (and after step()) is to normalize the values to within 0-1 so</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the NN can interpret them</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note that this assumes the search_space is greater than pi/2 (which shouldn't be a problem)</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        prev_state <span class="op">=</span> np.array([prev_state])<span class="op">/</span>env.search_space</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset all the episodic variables</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        episodic_reward <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        step_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        sum_actor_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        sum_critic_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run/step through a single episodes</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>            step_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show the enviornment</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>            env.render()</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This is the policy -- deciding what action to take</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the main actor output (i.e. "which action do I think we should take?")</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>            sampled_actions <span class="op">=</span> tf.squeeze(actor_model(prev_state)).numpy()</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> add_noise:</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>                <span class="co"># This should make the noise fade out over time (proportional to the actor learning</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># rate)</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># We want to fade the noise over time, *and* as we step through specific episodes</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>                total_cooldown   <span class="op">=</span> <span class="bu">max</span>(std_dev <span class="op">-</span> (ep  <span class="op">*</span> noise_cooldown), <span class="dv">0</span>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>                episode_cooldown <span class="op">=</span> <span class="bu">max</span>(std_dev <span class="op">-</span> (step_count <span class="op">*</span> noise_cooldown), <span class="dv">0</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>                sampled_actions <span class="op">+=</span> noise((total_cooldown <span class="op">+</span> episode_cooldown) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Make sure the action is in the action space</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>            action <span class="op">=</span> np.clip(sampled_actions, lower_bound, upper_bound)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the state and reward from environment</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>            state, reward, done, _, info <span class="op">=</span> env.step(action)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            state <span class="op">=</span> np.array([state])<span class="op">/</span>env.search_space</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Now stick the obvervation in the buffer so it can learn from it</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>            <span class="bu">buffer</span>.record(prev_state, action, reward, state)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This is where the Bellman equation is implemented</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>            actor_loss, critic_loss <span class="op">=</span> <span class="bu">buffer</span>.learn()</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Now update the NNs with the losses we just calculated</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            update_target(target_actor.variables, actor_model.variables, tau)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>            update_target(target_critic.variables, critic_model.variables, tau)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the episodic variables</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>            episodic_reward <span class="op">+=</span> reward</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>            sum_actor_loss <span class="op">+=</span> actor_loss</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>            sum_critic_loss <span class="op">+=</span> critic_loss</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_reward_yet <span class="op">&lt;</span> reward:</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>                best_state_yet <span class="op">=</span> state</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>                best_reward_yet <span class="op">=</span> reward</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Print a bunch of information to the enviornment window about this step</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We have to index these, it doesn't matter with what, because that's how SimpleGym works</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>            <span class="co"># It's very similar to why React components all need unique keys. Same concept.</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'dd'</span>] <span class="op">=</span> <span class="st">'Episode Stats'</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'step'</span>] <span class="op">=</span> <span class="ss">f'Step: </span><span class="sc">{</span>step_count<span class="sc">:.0f}</span><span class="ss">'</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'reward'</span>] <span class="op">=</span> <span class="ss">f'Reward: </span><span class="sc">{</span>reward<span class="sc">:.0f}</span><span class="ss">'</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'avg reward'</span>] <span class="op">=</span> <span class="ss">f'Avg. Reward for This Episode: </span><span class="sc">{</span>episodic_reward<span class="op">/</span>step_count<span class="sc">:.0f}</span><span class="ss">'</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'overlap'</span>] <span class="op">=</span> <span class="ss">f'Overlap: </span><span class="sc">{</span>info[<span class="st">"overlap"</span>]<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'len'</span>] <span class="op">=</span> <span class="ss">f'Side Length: </span><span class="sc">{</span>info[<span class="st">"len"</span>]<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'wasted'</span>] <span class="op">=</span> <span class="ss">f'Wasted Space: </span><span class="sc">{</span>info[<span class="st">"wasted"</span>]<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>            env.display(disp)</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> done: <span class="cf">break</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>            prev_state <span class="op">=</span> state</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Episode is done, now do some calculations</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># These are all just for plotting, not actually important to the algorithm</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>        ep_reward_list.append(episodic_reward)</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>        avg_reward <span class="op">=</span> np.mean(ep_reward_list[<span class="op">-</span>avg_reward_episodes:]) <span class="co"># Mean of last `avg_reward_episodes` episodes</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>        avg_reward_list.append(avg_reward)</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>        ep_actor_loss.append(sum_actor_loss <span class="op">/</span> step_count)</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>        ep_critic_loss.append(sum_critic_loss <span class="op">/</span> step_count)</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>        ep_len_list.append(step_count)</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print a bunch of information to the enviornment window about this episode</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'--'</span>] <span class="op">=</span> <span class="st">'-'</span><span class="op">*</span><span class="dv">20</span></span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'ddd'</span>] <span class="op">=</span> <span class="st">'Run Stats'</span></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'e'</span>] <span class="op">=</span> <span class="ss">f'Episode </span><span class="sc">{</span>env<span class="sc">.</span>reset_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_episodes<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'f'</span>] <span class="op">=</span> <span class="ss">f'Last Episode lasted </span><span class="sc">{</span>step_count<span class="sc">}</span><span class="ss"> steps'</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'g'</span>] <span class="op">=</span> <span class="ss">f'Last Episode Avg. Reward: </span><span class="sc">{</span>episodic_reward<span class="op">/</span>step_count<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'h'</span>] <span class="op">=</span> <span class="ss">f'Avg. Reward of the last </span><span class="sc">{</span>avg_reward_episodes<span class="sc">}</span><span class="ss"> episodes: </span><span class="sc">{</span>avg_reward<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'-'</span>] <span class="op">=</span> <span class="st">'-'</span><span class="op">*</span><span class="dv">20</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'avg steps'</span>] <span class="op">=</span> <span class="ss">f'Avg. Steps / Episode: </span><span class="sc">{</span>np<span class="sc">.</span>mean(ep_len_list) <span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'i'</span>] <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>((time.time_ns() <span class="op">-</span> start_time) <span class="op">/</span> <span class="dv">1000_000_000</span>) <span class="op">/</span> (ep<span class="op">+</span><span class="dv">1</span>)<span class="sc">:.1f}</span><span class="ss">s / Episode'</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>        env.<span class="bu">print</span>[<span class="st">'j'</span>] <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>((time.time_ns() <span class="op">-</span> start_time)<span class="op">/</span><span class="dv">1000_000</span>) <span class="op">/</span> <span class="bu">sum</span>(ep_len_list)<span class="sc">:.1f}</span><span class="ss">ms / step'</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Once we're finished with the simulation, clean up, make some graphs, and log everything we did</span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>    env.close()</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_reward_yet <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: <span class="co"># If this is the case, there was an error somewhere</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>        env.display()</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>        fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>        ax1.plot(avg_reward_list, label<span class="op">=</span><span class="st">'Avg. Reward'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>        ax1.set_xlabel(<span class="st">"Episode"</span>)</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>        ax1.set_ylabel(<span class="st">"Avg. Episodic Reward"</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>        ax1.axhline(y<span class="op">=</span><span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">'-'</span>)</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>        ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>        ax2.plot(ep_len_list, label<span class="op">=</span><span class="st">'Episode Length'</span>, color<span class="op">=</span><span class="st">'green'</span>, alpha<span class="op">=</span><span class="fl">.2</span>)</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>        ax2.set_ylabel(<span class="st">"Episode Length"</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>        ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>        fig.tight_layout()</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Losses</span></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>        fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>        ax1.plot(ep_critic_loss, label<span class="op">=</span><span class="st">'Avg Critic Loss'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>        ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>        ax2.plot(ep_actor_loss, label<span class="op">=</span><span class="st">'Avg Actor Loss'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>        ax1.legend()</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>        ax2.legend(loc<span class="op">=</span>(<span class="fl">.01</span>, <span class="fl">.8</span>))</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># These don't actually print, but get captured and put into the run log</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the numbers for the best state yet</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Best Reward yet: '</span>, best_reward_yet)</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Best State:'</span>)</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(best_state_yet)</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show the best state yet</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># I have no idea why this needs to be rescaled. It shouldn't, as far as I can tell</span></span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># But it's not super relevant. It just means we can't trust it to say whether we're</span></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># overlapping or not</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>        display(space2MultiPolygon(best_state_yet.reshape((env.N,<span class="dv">3</span>)), <span class="fl">.1</span>))</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show the models we used</span></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The target models are identical to these</span></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>        display(ks.utils.plot_model(actor_model,   show_layer_activations<span class="op">=</span><span class="va">True</span>, show_shapes<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>        display(ks.utils.plot_model(critic_model,  show_layer_activations<span class="op">=</span><span class="va">True</span>, show_shapes<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This saves the log to a directory named this</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>        save_output(run, <span class="st">'run9'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-log" class="level3">
<h3 class="anchored" data-anchor-id="example-log">Example Log</h3>
<p>Here is part of the log of the last run I did</p>
<div id="cell-35" class="cell">
<details class="code-fold">
<summary>Display Log</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>display(clear<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>run()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Best Reward yet:  423.74475850765157
Best State:
[[0.48985256 0.49015426 0.03719943 0.67339533 0.48970593 0.06476117
  0.85326362 0.49111193 0.0091013  0.97956313 0.5251773  0.01241833
  0.42890112 0.70183372 0.         0.61079882 0.60942355 0.08382925
  0.78974631 0.76345304 0.14279967 0.99174527 0.67113802 0.0109104
  0.42903404 0.79361329 0.14279967 0.691021   0.69134502 0.00892738
  0.91995521 0.91959155 0.03349545]]</code></pre>
</div>
<div class="cell-output cell-output-display">
ML Config:<br>gamma: 0.99<br>tau: 0.005<br>Buffer Capacity: 10000<br>Buffer Batch Size: 64<br>-------------------------<br>Env Config:<br>Number of Squares: 11<br>Max Steps: 1000<br>Max Overlap: 1<br>Shift Rate: 0.03<br>Rotation Rate: 0.02<br>Start Config: array<br>Boundary: 2<br>Bound Method: mixed<br>-------------------------<br>Episode Stats<br>Step: 457<br>Reward: 60<br>Avg. Reward for This Episode: 98<br>Overlap: 0.0<br>Side Length: 8.2<br>Wasted Space: 56.0<br>--------------------<br>Run Stats<br>Episode 1000/1000<br>Last Episode lasted 457 steps<br>Last Episode Avg. Reward: 98.0<br>Avg. Reward of the last 40 episodes: 29839.6<br>--------------------<br>Avg. Steps / Episode: 361.2<br>3.8s / Episode<br>10.5ms / step
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-5.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Save the weights outside of the log</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>actor_model.save_weights(actor_weights_file)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>critic_model.save_weights(critic_weights_file)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>target_actor.save_weights(target_actor_weights_file)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>target_critic.save_weights(target_critic_weights_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>I wasn’t able to find a better configuration than the best known (which isn’t super surprising). I didn’t actually end up seeing much progress. Having trained a couple DDPG’s before, I know usually you start <em>at least</em> seeing progress after a couple hundred episodes of training. This problem is much harder than the ones I’ve worked on before, but I didn’t see really <em>any</em> progress after 500 episodes.</p>
<p>You can see the specific hyperparameters and configurations I tried (on GitHub)[https://github.com/smartycope/SquarePacking/tree/master/runs]</p>
<p>When you try a bunch of things, and none of them seem to work <em>at all</em>, it becomes hard to know what to try next.</p>
<section id="my-guesses-as-to-what-is-wrong" class="level3">
<h3 class="anchored" data-anchor-id="my-guesses-as-to-what-is-wrong">My Guesses as to What is Wrong</h3>
<ul>
<li>I overlooked some simple or not-so-simple flaw in the algorithm I set up, and it’s not training because I set it up wrong
<ul>
<li>Solutions:
<ul>
<li>Have someone who knows much more than I do about RL algorithms go over my code with a fine-toothed comb and implement what they suggest</li>
</ul></li>
</ul></li>
<li>My observation space is too “abstract” (for lack of a better word), and doesn’t adequately encode the positional relationships between the squares
<ul>
<li>Solutions:
<ul>
<li>Make the observation space multi-dimentional (say, a shape of <code>(11, 3)</code> instead of <code>(33,)</code>), and try adding a convolutional layer as the first layer of the actor network</li>
<li>Change the observation space to be a screen, and add a few convolutional layers as the first layers of the actor network</li>
</ul></li>
</ul></li>
<li>The problem is fundementally too difficult to be solved with a DDPG
<ul>
<li>Solutions:
<ul>
<li>Switch to a different kind of ML architecture, like a transformer network</li>
<li>Try a different kind of heuristic algorithm…</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="a-different-kind-of-hueristic-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="a-different-kind-of-hueristic-algorithm">A Different Kind of Hueristic Algorithm</h3>
<p>If I had more time, and was willing to scrap everything and start over, I would try a more monte carlo/simulated annealing approach. Something like this:</p>
<ol type="1">
<li>randomly make discrete movements/rotations of <code>rot_rate</code>, <code>shift_rate</code></li>
<li>decide if it’s better or not according to my reward function</li>
<li>if it’s better, keep going, if it’s worse, undo it some of the time, and keep it anyway some of the time (<code>r</code>)</li>
</ol>
<p>Then, have <code>rot_rate</code>, <code>shift_rate</code>, and <code>r</code> decrease slowly as time goes on, to slowly anneal to a more optimal configuration.</p>
<p>Credit where it’s due, the idea for this was inspired by <a href="https://www.youtube.com/watch?v=Lq-Y7crQo44&amp;pp=ygUVZ2VycnltYW5kZXJpbmcgYWxwaGEg">this YouTube video</a> on algorithmic gerrymandering</p>
<section id="i-did-it" class="level4">
<h4 class="anchored" data-anchor-id="i-did-it">I did it</h4>
<p>I ended up implementing that algorithm after all. Here it is, I’ll only go into detail about the parts that I haven’t discussed above. I used the same environment and hardware to run it as I did above.</p>
<p>I added cooldown to the variables <code>rand</code> (the chance that we make a bad move), <code>rot</code> (the max amount of rotation we can make in a single step), and <code>shift</code> (the max amount of translation we can make in a single step). You can see the graph below for the rates at which they decrease.</p>
<p>Inspired by <a href="https://www.youtube.com/watch?v=Lq-Y7crQo44&amp;pp=ygUVZ2VycnltYW5kZXJpbmcgYWxwaGEg">the above YouTube video</a>, I tried adding an <code>overlap phase</code>. My thinking was that after it starts to approach a local minimum, a lower minimum may be blocked by say, the corner of a different square. If it could just get over there, it would be able to optimize further. This didn’t end up working, and seemed to just make squares overlap, which reduced the reward and had a hard time getting back.</p>
<p>Note that this portion is independantly runnable, but you will need to run the <code>Dependant Code</code> section first for it to work.</p>
<div id="cell-42" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Imports</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> randint</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools <span class="im">as</span> it</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># from Cope import percent</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># from SquareEnv2 import space2MultiPolygon, SquareEnv</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-43" class="cell" data-execution_count="23">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Reward Function</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify the reward function</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_reward(<span class="va">self</span>):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We generally prefer living longer</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> <span class="dv">0</span> <span class="co"># Linear</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    centered_importance <span class="op">=</span> <span class="fl">.5</span> <span class="co"># Exponential</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    score <span class="op">-=</span> <span class="va">self</span>.side_len</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We don't like it when they overlap at all</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.overlap_area <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        score <span class="op">-=</span> <span class="dv">10</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We also want to disincentivize overlapping more, so we can tell if we're starting to</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># un-overlap (which is better than overlapping more)</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        score <span class="op">-=</span> <span class="va">self</span>.overlap_area</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I don't want them to just push up against the edges</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> centered_importance:</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x, y, _rot <span class="kw">in</span> <span class="va">self</span>.squares:</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove boundary badness entirely for optimization</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We want the squares to be close to the center</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> centered_importance:</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>                score <span class="op">-=</span> dist([x, y], [<span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>, <span class="va">self</span>.search_space <span class="op">/</span> <span class="dv">2</span>]) <span class="op">*</span> centered_importance</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> score</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>SquareEnv._get_reward <span class="op">=</span> _get_reward</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>modify the environment terminated function</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_terminated(<span class="va">self</span>):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optimal: 3.789, best known: 3.877084</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># There's no overlapping and we're better than the previous best</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.N <span class="op">==</span> <span class="dv">11</span> <span class="kw">and</span> <span class="va">self</span>.side_len <span class="op">&lt;</span> <span class="fl">3.877084</span> <span class="kw">and</span> <span class="va">self</span>.is_valid():</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Holy cow, we did it!!!'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Coordinates &amp; Rotations:'</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.squares)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'~/SQUARE_PARAMETERS.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="bu">str</span>(<span class="va">self</span>.squares))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we're almost entirely overlapping, just kill it</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.overlap_area <span class="op">&gt;</span> <span class="va">self</span>.max_overlap:</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the deadlock detection, since it breaks when we only move 1 square at a time</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>SquareEnv._get_terminated <span class="op">=</span> _get_terminated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-45" class="cell" data-execution_count="25">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Configuration &amp; Enviorment</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> SquareEnv(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    N<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It can handle a smaller search space, it speeds things up a little</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    search_space<span class="op">=</span><span class="fl">5.5</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    render_mode<span class="op">=</span><span class="st">"pygame"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are the upper bounds</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    shift_rate<span class="op">=</span><span class="fl">.05</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    rot_rate<span class="op">=</span><span class="fl">.03</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    max_steps<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    bound_method<span class="op">=</span><span class="st">'mixed'</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This changes later</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    disallow_overlap<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    boundary<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Arbitrarily high overlap: to allow for an "overlap phase" (see below)</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    max_overlap<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I tried both `valid` and `array`</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    start_config<span class="op">=</span><span class="st">'valid'</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    screen_size<span class="op">=</span>(<span class="dv">300</span>, <span class="dv">400</span>),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="26">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Hyperparameters</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many resets we're running for.</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>total_episodes <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The starting constants</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>rand <span class="op">=</span> <span class="fl">.5</span> <span class="co"># Percent</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The starting rates will always be the highest</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>rot <span class="op">=</span> env.rot_rate</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>shift <span class="op">=</span> env.shift_rate</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The smallest they're allowed to get</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>_min_rand <span class="op">=</span> <span class="fl">.01</span> <span class="co"># percent</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>_min_rot <span class="op">=</span> <span class="fl">.0001</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>_min_shift <span class="op">=</span> <span class="fl">.0001</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># How much we allow the probability to be modified, based on the score difference</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>rand_modify_limit <span class="op">=</span> <span class="kw">lambda</span> rand: rand <span class="op">*</span> <span class="fl">.5</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># The steps at which each phase starts and ends</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># This is disabled at the moment: I found it tended to hinder more than help</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>overlap_phase <span class="op">=</span> (env.max_steps <span class="op">*</span> <span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify a manual rand value while in the overlap_phase (to encourage exploration)</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>overlap_phase_rand <span class="op">=</span> rand</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co"># The cooldown functions</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># These specify how we want to "cooldown" or decrease the values rand, rot, and shift over steps</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co"># There's a lot of oppritunity for tuning these functions. In particular, I want to expirement with</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># rot and shift functions that are "hilly", and increase and decrease the movement rates cyclicly.</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>cooldown <span class="op">=</span> <span class="va">True</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>rand_func  <span class="op">=</span> <span class="kw">lambda</span> step: (</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    overlap_phase_rand</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> step <span class="op">&gt;</span> overlap_phase[<span class="dv">0</span>] <span class="kw">and</span> step <span class="op">&lt;</span> overlap_phase[<span class="dv">1</span>]</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> np.clip(<span class="op">-</span><span class="fl">.000003</span><span class="op">*</span>step  <span class="op">+</span> rand,  _min_rand, rand)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>rot_func   <span class="op">=</span> <span class="kw">lambda</span> step: np.clip(<span class="op">-</span><span class="fl">.0000002</span><span class="op">*</span>step <span class="op">+</span> rot,   _min_rot, rot)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>shift_func <span class="op">=</span> <span class="kw">lambda</span> step: np.clip(<span class="op">-</span><span class="fl">.0000003</span><span class="op">*</span>step <span class="op">+</span> shift, _min_shift, shift)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Make a graph of the cooldown rates</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">1</span>, env.max_steps <span class="cf">if</span> env.max_steps <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">100_000</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x, <span class="bu">list</span>(<span class="bu">map</span>(rand_func, x)), label<span class="op">=</span><span class="st">'random cooldown'</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x, rot_func(x), label<span class="op">=</span><span class="st">'rotation cooldown'</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>plt.plot(x, shift_func(x), label<span class="op">=</span><span class="st">'shift cooldown'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Show our configuration in the window</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>env.show_strings <span class="op">=</span> [</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'-------------------------'</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Env Config:'</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Number of Squares: </span><span class="sc">{</span>env<span class="sc">.</span>N<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Max Steps: </span><span class="sc">{</span>env<span class="sc">.</span>max_steps<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Max Overlap: </span><span class="sc">{</span>env<span class="sc">.</span>max_overlap<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Shift Rate: </span><span class="sc">{</span>env<span class="sc">.</span>shift_rate<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Rotation Rate: </span><span class="sc">{</span>env<span class="sc">.</span>rot_rate<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Start Config: </span><span class="sc">{</span>env<span class="sc">.</span>start_config<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Boundary: </span><span class="sc">{</span>env<span class="sc">.</span>boundary<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'Bound Method: </span><span class="sc">{</span>env<span class="sc">.</span>bound_method<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'-------------------------'</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-49" class="cell" data-execution_count="29">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Main Loop</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To store reward history of each episode (for plotting)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>reward_lists <span class="op">=</span> []</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>overlap_lists <span class="op">=</span> []</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>best_state_yet <span class="op">=</span> <span class="va">None</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>best_reward_yet <span class="op">=</span> <span class="op">-</span><span class="dv">10000000000</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>best_side_len_yet <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure this is set at the beginning of each new run</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>env.disallow_overlap <span class="op">=</span> <span class="va">True</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run through `total_episodes` number of enviorment resets</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ep <span class="kw">in</span> <span class="bu">range</span>(total_episodes):</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        prev_state, _ <span class="op">=</span> env.reset()</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        prev_reward <span class="op">=</span> env._get_reward()</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        episodic_reward <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        reward_lists.append([])</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        overlap_lists.append([<span class="dv">0</span>])</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time_ns()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run/step through a single episodes</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> step <span class="kw">in</span> it.count(<span class="dv">1</span>):</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>            env.render()</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate the cooldown values for this step</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Underscored variables here indicate variables that get reset each step</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>            _rand <span class="op">=</span> rand_func(step) <span class="cf">if</span> cooldown <span class="cf">else</span> rand</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>            _shift <span class="op">=</span> shift_func(step) <span class="cf">if</span> cooldown <span class="cf">else</span> shift</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            _rot <span class="op">=</span> rot_func(step) <span class="cf">if</span> cooldown <span class="cf">else</span> rot</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>            _overlap_phase <span class="op">=</span> step <span class="op">&gt;</span> overlap_phase[<span class="dv">0</span>] <span class="kw">and</span> step <span class="op">&lt;</span> overlap_phase[<span class="dv">1</span>]</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            _rand_limit <span class="op">=</span> rand_modify_limit(_rand)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Allow overlap, if we're in the overlap phase</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _overlap_phase:</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>                env.disallow_overlap <span class="op">=</span> <span class="va">False</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Make a random action</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only move one square at a time: if we move all at the same time, then 3 of them might</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># be really good moves, but one is a bad move that invalidates all of them.</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>            action <span class="op">=</span> np.zeros((env.N, <span class="dv">3</span>))</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>            action[randint(<span class="dv">0</span>, env.N<span class="op">-</span><span class="dv">1</span>)] <span class="op">=</span> [</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>                <span class="co"># </span><span class="al">TODO</span><span class="co">: Next, I want to try expirmenting with other statistical distrobutions</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>                random.uniform(<span class="op">-</span>_shift, _shift),</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>                random.uniform(<span class="op">-</span>_shift, _shift),</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>                random.uniform(<span class="op">-</span>_rot, _rot),</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: optimization: we're flattening here to then immediately unflatten in the environment _step method</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            action <span class="op">=</span> action.flatten()</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Recieve state and reward from environment</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>            state, reward, done, _, info <span class="op">=</span> env.step(action)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Modify the chance of accepting the change based on the amount of reward difference: but limit to between</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># +/- _rand_limit, since a negative percentage doesn't make much sense, and we still want some randomness</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>            _chance <span class="op">=</span> _rand <span class="op">+</span> np.clip((prev_reward <span class="op">-</span> reward) <span class="op">*</span> <span class="dv">10</span>, <span class="op">-</span>_rand_limit, _rand_limit)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If we're overlapping more than we were before, minimize the odds that we'll keep the movement</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># </span><span class="al">NOTE</span><span class="co">: We can't set _chance to 0 here, or else once we overlap during the overlap phase, we won't be able</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># to get out</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> _overlap_phase <span class="kw">and</span> info[<span class="st">'overlap'</span>] <span class="op">&gt;</span> overlap_lists[ep][<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>                _chance <span class="op">=</span> _rand <span class="op">-</span> _rand_limit</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>                (</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If we're overlaping at all, and it's not the overlap phase, or if our current state is worse than</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># the one before we made the move, undo the move we just took `_chance`% of the time.</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># We don't want to do it *all* the time, because we'd quickly only find the local minumum.</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># This is the premise of simulated annealing</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>                    (info[<span class="st">'overlap'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _overlap_phase)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">or</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>                    reward <span class="op">&lt;</span> prev_reward</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>                <span class="kw">and</span> <span class="kw">not</span> percent(_chance)</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>            ):</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Step back - undo what we just did</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>                state, reward, done, _, info <span class="op">=</span> env.step(<span class="op">-</span>action)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If we've finished the overlap phase, and we've gotten to a point where we're no longer overlapping,</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># disable overlap again</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> env.disallow_overlap <span class="kw">and</span> <span class="kw">not</span> info[<span class="st">'overlap'</span>]:</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>                env.disallow_overlap <span class="op">=</span> <span class="va">True</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ------------------ Not part of the algorithm --------------------</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>            reward_lists[ep].append(reward)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>            overlap_lists[ep].append(info[<span class="st">'overlap'</span>])</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_side_len_yet <span class="op">&gt;</span> info[<span class="st">'len'</span>]:</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>                best_state_yet <span class="op">=</span> state</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                best_side_len_yet <span class="op">=</span> info[<span class="st">'len'</span>]</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>                best_reward_yet <span class="op">=</span> reward</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>            episodic_reward <span class="op">+=</span> reward</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'e'</span>] <span class="op">=</span> <span class="ss">f'Episode </span><span class="sc">{</span>env<span class="sc">.</span>reset_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_episodes<span class="sc">}</span><span class="ss">:'</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'step'</span>] <span class="op">=</span> <span class="ss">f'Step: </span><span class="sc">{</span>step<span class="sc">:.0f}</span><span class="ss">'</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'reward'</span>] <span class="op">=</span> <span class="ss">f'Reward: </span><span class="sc">{</span>reward<span class="sc">:.3f}</span><span class="ss">'</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'overlap'</span>] <span class="op">=</span> <span class="ss">f'Overlap: </span><span class="sc">{</span>info[<span class="st">"overlap"</span>]<span class="sc">:.5f}</span><span class="ss">'</span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'len'</span>] <span class="op">=</span> <span class="ss">f'Side Length: </span><span class="sc">{</span>info[<span class="st">"len"</span>]<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'wasted'</span>] <span class="op">=</span> <span class="ss">f'Wasted Space: </span><span class="sc">{</span>info[<span class="st">"wasted"</span>]<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'_rand'</span>] <span class="op">=</span> <span class="ss">f'annealing coeff: </span><span class="sc">{</span>_rand<span class="sc">:.5f}</span><span class="ss">'</span></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'_shift'</span>] <span class="op">=</span> <span class="ss">f'shift rate: </span><span class="sc">{</span>_shift<span class="sc">:.5f}</span><span class="ss">'</span></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'_rot'</span>] <span class="op">=</span> <span class="ss">f'rotation rate: </span><span class="sc">{</span>_rot<span class="sc">:.5f}</span><span class="ss">'</span></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'avg reward'</span>] <span class="op">=</span> <span class="ss">f'Avg. Reward for This Episode: </span><span class="sc">{</span>episodic_reward<span class="op">/</span>step<span class="sc">:.2f}</span><span class="ss">'</span></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'phase'</span>] <span class="op">=</span> <span class="ss">f"Phase: </span><span class="sc">{</span><span class="st">'Overlap'</span> <span class="cf">if</span> _overlap_phase <span class="cf">else</span> <span class="st">'Main'</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'eee'</span>] <span class="op">=</span> <span class="ss">f'_rand: </span><span class="sc">{</span>_chance<span class="sc">:.2%}</span><span class="ss">'</span></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>            env.<span class="bu">print</span>[<span class="st">'j'</span>] <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>((time.time_ns() <span class="op">-</span> start_time)<span class="op">/</span><span class="dv">1000_000</span>) <span class="op">/</span> step<span class="sc">:.2f}</span><span class="ss">ms / step'</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> done: <span class="cf">break</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>            prev_state <span class="op">=</span> state</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>            prev_reward <span class="op">=</span> reward</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>    env.close()</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_reward_yet <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make the graph, and display some of the output</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>        env.display()</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>        fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ep, i <span class="kw">in</span> <span class="bu">enumerate</span>(reward_lists):</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>            ax1.plot(i, label<span class="op">=</span><span class="ss">f'Episode </span><span class="sc">{</span>ep<span class="sc">}</span><span class="ss"> reward'</span>)</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>        ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="bu">len</span>(<span class="bu">max</span>(reward_lists, key<span class="op">=</span><span class="bu">len</span>))))</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>        ax2.plot(x, <span class="bu">list</span>(<span class="bu">map</span>(rand_func, x)), label<span class="op">=</span><span class="st">'random cooldown'</span>, alpha<span class="op">=</span><span class="fl">.4</span>)</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>        ax2.plot(rot_func(x), label<span class="op">=</span><span class="st">'rotation cooldown'</span>, alpha<span class="op">=</span><span class="fl">.4</span>)</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>        ax2.plot(shift_func(x), label<span class="op">=</span><span class="st">'shift cooldown'</span>, alpha<span class="op">=</span><span class="fl">.4</span>)</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ep, i <span class="kw">in</span> <span class="bu">enumerate</span>(overlap_lists):</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>            ax2.plot(i, label<span class="op">=</span><span class="ss">f'Episode </span><span class="sc">{</span>ep<span class="sc">}</span><span class="ss"> overlap'</span>)</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>        ax1.legend()</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>        ax2.legend()</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ax1.vlines(overlap_phase, -22, -3)</span></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Best side length yet: '</span>, best_side_len_yet)</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Best Reward yet: '</span>, best_reward_yet)</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Best State:'</span>)</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(best_state_yet)</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>        display(space2MultiPolygon(best_state_yet.reshape((env.N,<span class="dv">3</span>)), <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-display">
-------------------------<br>Env Config:<br>Number of Squares: 11<br>Max Steps: 100000<br>Max Overlap: 5<br>Shift Rate: 0.05<br>Rotation Rate: 0.03<br>Start Config: valid<br>Boundary: 0<br>Bound Method: mixed<br>-------------------------<br>Episode 1/1:<br>Step: 83921<br>Reward: -11.434<br>Overlap: 0.00000<br>Side Length: 4.3<br>Wasted Space: 7.8<br>annealing coeff: 0.24824<br>shift rate: 0.02482<br>rotation rate: 0.01322<br>Avg. Reward for This Episode: -12.34<br>Phase: Main<br>_rand: 29.67%<br>3.66ms / step
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-29-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Best side length yet:  4.2757519302189095
Best Reward yet:  -11.537943776434863
Best State:
[2.33215984 1.64005651 1.23660412 2.85851348 3.68318778 1.35392014
 0.97938896 3.20995917 1.17055286 4.056265   4.44360427 1.51664717
 3.90260406 2.22845498 1.22983613 2.92982993 2.53654343 1.21451204
 1.85830051 4.03639402 1.39096229 3.84755382 3.34973736 1.36236215
 3.30502829 1.3204964  1.26810013 1.22718773 1.96212431 1.24175536
 1.93874577 2.88557254 1.15993837]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-29-output-4.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index.png" class="img-fluid figure-img"></p>
<figcaption>This is what it looks like when it’s running</figcaption>
</figure>
</div>
<p>This is a graph of when I tried using the <code>overlap_phase</code>. In the reward function, I disincentivized overlapping at all, and then additionally disincentivized the amount of overlap. As you can see, once overlap is allowed, it starts doing so, and the reward plumets. I don’t want to stop disincentivizing overlap during the overlap phase, because then it would quickly all collapse to the center. I ended up removing the overlap phase entirely based on this graph, because you can see the reward increasing, and suddenly dropping, and then rising back up to along the same curve as you can see in the graph above.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-53-1-image.png" class="img-fluid figure-img"></p>
<figcaption>With an overlap phase</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="summary-part-2" class="level2">
<h2 class="anchored" data-anchor-id="summary-part-2">Summary Part 2</h2>
<p>Using the simulated annealing method ended up working significantly better than the DDPG algorithm. You can actually see it making progress while it’s running, and while the reward values aren’t comparable, the graphs clearly show improvement while using simulated annealing as opposed to the DDPG algorithm.</p>
<p>I wasn’t able to find a better configuration than the best known, the best I could do was ~4.276. However, I feel like there’s still untapped potential here. I only started on the 2nd algorithm in the last couple of days, and plan to continue to fine-tune it going forward.</p>
<div id="cell-55" class="cell" data-execution_count="79">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 32%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>Configuration</th>
<th>Side length</th>
<th>Image</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Calculated Optimal</td>
<td>3.789</td>
<td>???</td>
</tr>
<tr class="even">
<td>Best Known</td>
<td>3.877</td>
<td><img src="index_files/figure-html/cell-56-3-image.png" class="img-fluid"></td>
</tr>
<tr class="odd">
<td>Mine</td>
<td>4.276</td>
<td><img src="index_files/figure-html/cell-56-2-image-3.png" class="img-fluid"></td>
</tr>
<tr class="even">
<td>Trivial</td>
<td>4.339</td>
<td><img src="index_files/figure-html/cell-56-1-image-2.png" class="img-fluid"></td>
</tr>
</tbody>
</table>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/smartycope\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copeland Carter, 2024</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="emailto:smartycope@gmail.com" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>